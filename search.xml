<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>å¦‚ä½•åœ¨k8sä¸­ä½¿ç”¨GCSå¤‡ä»½ESæ•°æ®</title>
      <link href="//post/ru-he-zai-k8s-zhong-shi-yong-gcs-bei-fen-es-shu-ju.html"/>
      <url>//post/ru-he-zai-k8s-zhong-shi-yong-gcs-bei-fen-es-shu-ju.html</url>
      
        <content type="html"><![CDATA[<p>Elasticsearch æ˜¯ä¸€ä¸ªè¶…çº§ç‚«é…·çš„å¼€æºæœç´¢å¼•æ“ï¼Œå¯ä»¥åœ¨å„ç§ä¸åŒçš„ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ä¸ºäº†å¦¥å–„ä¿ç®¡æ•°æ®ï¼Œå°±å¿…é¡»å¾—å¤‡ä»½ ES é›†ç¾¤æ•°æ®ã€‚é‰´äºå…¬å¸çš„ k8s é›†ç¾¤éƒ¨ç½²åœ¨ GCP ä¸Šï¼Œè‡ªç„¶è€Œç„¶æƒ³åˆ°äº†ä½¿ç”¨ GCS ä½œä¸ºå¤‡ä»½æ•°æ®å­˜å‚¨ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€æ­¥éœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªæœåŠ¡å¸å·ä¾› repository-gcs æ’ä»¶ä½¿ç”¨ï¼Œä¸€å®šè¦æ³¨æ„è¿™ä¸ªæœåŠ¡è´¦å·å¿…é¡»è¦æœ‰gcsçš„æƒé™ã€‚</li><li>åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬éœ€è¦åˆ›å»ºå¤‡ä»½repositoryã€æ£€æŸ¥å¤‡ä»½ä»»åŠ¡ç­‰ç­‰ã€‚</li></ol><h3 id="é…ç½®-GCS-å­˜å‚¨æ¡¶"><a href="#é…ç½®-GCS-å­˜å‚¨æ¡¶" class="headerlink" title="é…ç½® GCS å­˜å‚¨æ¡¶"></a>é…ç½® GCS å­˜å‚¨æ¡¶</h3><p>é¦–å…ˆï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ª GCS å­˜å‚¨æ¡¶å¹¶é…ç½®è®¿é—®æƒé™ã€‚è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªç”¨äºå¤‡ä»½çš„æœåŠ¡è´¦å·ï¼Œå¹¶èµ‹äºˆå®ƒå­˜å‚¨æ¡¶çš„å†™å…¥æƒé™ã€‚æœ€åï¼Œåœ¨ k8s ä¸­é…ç½®è¯¥æœåŠ¡è´¦å·çš„å¯†é’¥ï¼Œä»¥ä¾¿å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¿é—® GCSã€‚(ç”±äºå…¬å¸é›†ç¾¤å°±åœ¨GCPä¸Šéƒ¨ç½²ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰è¿™æ ·åšï¼Œè€Œæ˜¯ä½¿ç”¨äº†<a href="https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn">å·¥ä½œè´Ÿè½½èº«ä»½è”åˆ</a>)</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gcs<span class="token punctuation">-</span>credentials<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque<span class="token key atrule">stringData</span><span class="token punctuation">:</span>  <span class="token key atrule">credentials.json</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    {      "type": "service_account",      "project_id": "my-project",      "private_key_id": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",      "private_key": "-----BEGIN PRIVATE KEY-----\\nMIIEvQIBADANBgkqhkiG9w0B...",      "client_email": "my-service-account@my-project.iam.gserviceaccount.com",      "client_id": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",      "auth_uri": "https://accounts.google.com/o/oauth2/auth",      "token_uri": "https://accounts.google.com/o/oauth2/token",      "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",      "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/my-service-account%40my-project.iam.gserviceaccount.com"    }</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é…ç½®-ES-é›†ç¾¤"><a href="#é…ç½®-ES-é›†ç¾¤" class="headerlink" title="é…ç½® ES é›†ç¾¤"></a>é…ç½® ES é›†ç¾¤</h2><p>ç„¶åéœ€è¦åœ¨ ES é›†ç¾¤ä¸­é…ç½® GCS å¤‡ä»½ã€‚å¯ä»¥ä½¿ç”¨<code>repository-gcs</code> æ’ä»¶æ¥å®ç°ã€‚è¯¥æ’ä»¶å¯ä»¥å°† ES æ•°æ®å¤‡ä»½åˆ° GCS å­˜å‚¨æ¡¶ä¸­ï¼Œå¹¶ä»å­˜å‚¨æ¡¶ä¸­æ¢å¤æ•°æ®ã€‚éœ€è¦åœ¨æ¯ä¸ª ES èŠ‚ç‚¹ä¸Šå®‰è£…è¯¥æ’ä»¶ï¼Œå¹¶åœ¨é›†ç¾¤é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  GCS å­˜å‚¨æ¡¶çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> elasticsearch.k8s.elastic.co/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Elasticsearch<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> elastic<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nodeSets</span><span class="token punctuation">:</span><span class="token punctuation">...</span>      <span class="token key atrule">podTemplate</span><span class="token punctuation">:</span>        <span class="token key atrule">spec</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> es <span class="token comment"># ä½¿ç”¨äº†[å·¥ä½œè´Ÿè½½èº«ä»½è”åˆ](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn)</span><span class="token punctuation">...</span>          <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>plugins <span class="token comment"># å®‰è£…æ’ä»¶</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> sh                <span class="token punctuation">-</span> <span class="token punctuation">-</span>c                <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">                  bin/elasticsearch-plugin install --batch repository-gcs</span><span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ›å»ºå¤‡ä»½è®¡åˆ’"><a href="#åˆ›å»ºå¤‡ä»½è®¡åˆ’" class="headerlink" title="åˆ›å»ºå¤‡ä»½è®¡åˆ’"></a>åˆ›å»ºå¤‡ä»½è®¡åˆ’</h2><p>ç”±äºæˆ‘ä»¬éœ€è¦è®©eså¼€å¯å®šæœŸå¤‡ä»½æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªè„šæœ¬ï¼Œåœ¨ESå¯åŠ¨åæ£€æŸ¥è¯¥ä»»åŠ¡æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œä¸ºäº†èƒ½å¤Ÿå°†è¯¥è„šæœ¬åœ¨ESä¸­ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¯¥è„šæœ¬åˆ›å»ºä¸€ä¸ªconfigmapã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$ES_URL</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token assign-left variable">ES_URL</span><span class="token operator">=</span><span class="token string">"http://localhost:9200"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$ES_USERNAME</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token builtin class-name">echo</span> <span class="token string">"ES_USERNAME is not set"</span>  <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$ES_PASSWORD</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token builtin class-name">echo</span> <span class="token string">"ES_PASSWORD is not set"</span>  <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$BUCKET</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token assign-left variable">BUCKET</span><span class="token operator">=</span><span class="token string">"es-backup"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$BASE_PATH</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token assign-left variable">BASE_PATH</span><span class="token operator">=</span><span class="token string">"backup"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$SNAPSHOT_NAME</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token assign-left variable">SNAPSHOT_NAME</span><span class="token operator">=</span><span class="token string">"test"</span><span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$SCHEDULE</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token assign-left variable">SCHEDULE</span><span class="token operator">=</span><span class="token string">"0 0 14 * * ?"</span> <span class="token comment"># æ¯å¤©14ç‚¹æ‰§è¡Œ</span><span class="token keyword">fi</span><span class="token assign-left variable">AUTH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$ES_USERNAME</span>:<span class="token variable">$ES_PASSWORD</span>"</span> <span class="token operator">|</span> base64<span class="token variable">)</span></span><span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-w</span> <span class="token string">"%{http_code}"</span> <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Basic <span class="token variable">$AUTH</span>"</span> $ES_URL<span class="token variable">)</span></span>"</span> <span class="token operator">!=</span> <span class="token string">"200"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Elasticsearch is not ready yet"</span>    <span class="token function">sleep</span> <span class="token number">1</span><span class="token keyword">done</span><span class="token builtin class-name">echo</span> <span class="token string">"Elasticsearch is up and running!"</span><span class="token comment"># æ£€æŸ¥_snapshot/$SNAPSHOT_NAMEæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span><span class="token assign-left variable">resp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-w</span> <span class="token string">"%{http_code}"</span> <span class="token parameter variable">-X</span> GET  <span class="token string">"<span class="token variable">$ES_URL</span>/_snapshot/<span class="token variable">$SNAPSHOT_NAME</span>"</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-H</span> <span class="token string">"Accept: application/json"</span> <span class="token punctuation">\</span>    <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Basic <span class="token variable">$AUTH</span>"</span><span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$resp</span> <span class="token operator">==</span> <span class="token string">"200"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$SNAPSHOT_NAME</span> snapshot already exists."</span><span class="token keyword">else</span>    <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-w</span> <span class="token string">"%{http_code}"</span> <span class="token parameter variable">-X</span> PUT <span class="token string">"<span class="token variable">$ES_URL</span>/_snapshot/<span class="token variable">$SNAPSHOT_NAME</span>"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-H</span> <span class="token string">"Accept: application/json"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-H</span> <span class="token string">"content-type: application/json"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Basic <span class="token variable">$AUTH</span>"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-d</span> <span class="token string">"{            <span class="token entity" title="\&quot;">\"</span>type<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span>gcs<span class="token entity" title="\&quot;">\"</span>,            <span class="token entity" title="\&quot;">\"</span>settings<span class="token entity" title="\&quot;">\"</span>: {              <span class="token entity" title="\&quot;">\"</span>bucket<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span><span class="token variable">$BUCKET</span><span class="token entity" title="\&quot;">\"</span>,              <span class="token entity" title="\&quot;">\"</span>base_path<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span><span class="token variable">$BASE_PATH</span><span class="token entity" title="\&quot;">\"</span>            }          }"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">"200"</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$SNAPSHOT_NAME</span> snapshot has been created."</span><span class="token keyword">fi</span><span class="token comment"># æ£€æŸ¥snapshot policyæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span><span class="token assign-left variable">resp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-w</span> <span class="token string">"%{http_code}"</span> <span class="token parameter variable">-X</span> GET  <span class="token string">"<span class="token variable">$ES_URL</span>/_slm/policy/<span class="token variable">$SNAPSHOT_NAME</span>-snapshots"</span> <span class="token punctuation">\</span>           <span class="token parameter variable">-H</span> <span class="token string">"Accept: application/json"</span> <span class="token punctuation">\</span>           <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Basic <span class="token variable">$AUTH</span>"</span><span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$resp</span> <span class="token operator">==</span> <span class="token string">"200"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$SNAPSHOT_NAME</span>-snapshots snapshot policy already exists."</span><span class="token keyword">else</span>    <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-w</span> <span class="token string">"%{http_code}"</span> <span class="token parameter variable">-X</span> PUT  <span class="token string">"<span class="token variable">$ES_URL</span>/_slm/policy/<span class="token variable">$SNAPSHOT_NAME</span>-snapshots"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-H</span> <span class="token string">"Accept: application/json"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-H</span> <span class="token string">"content-type: application/json"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-H</span> <span class="token string">"Authorization: Basic <span class="token variable">$AUTH</span>"</span> <span class="token punctuation">\</span>        <span class="token parameter variable">-d</span> <span class="token string">"{            <span class="token entity" title="\&quot;">\"</span>schedule<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span><span class="token variable">$SCHEDULE</span><span class="token entity" title="\&quot;">\"</span>,            <span class="token entity" title="\&quot;">\"</span>name<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span>&lt;<span class="token variable">$SNAPSHOT_NAME</span>-snapshots-{now/d/H}&gt;<span class="token entity" title="\&quot;">\"</span>,            <span class="token entity" title="\&quot;">\"</span>repository<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span><span class="token variable">$SNAPSHOT_NAME</span><span class="token entity" title="\&quot;">\"</span>,            <span class="token entity" title="\&quot;">\"</span>config<span class="token entity" title="\&quot;">\"</span>: {                <span class="token entity" title="\&quot;">\"</span>expand_wildcards<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span>all<span class="token entity" title="\&quot;">\"</span>,                <span class="token entity" title="\&quot;">\"</span>ignore_unavailable<span class="token entity" title="\&quot;">\"</span>: true,                <span class="token entity" title="\&quot;">\"</span>include_global_state<span class="token entity" title="\&quot;">\"</span>: false            },            <span class="token entity" title="\&quot;">\"</span>retention<span class="token entity" title="\&quot;">\"</span>: {              <span class="token entity" title="\&quot;">\"</span>expire_after<span class="token entity" title="\&quot;">\"</span>: <span class="token entity" title="\&quot;">\"</span>30d<span class="token entity" title="\&quot;">\"</span>,              <span class="token entity" title="\&quot;">\"</span>min_count<span class="token entity" title="\&quot;">\"</span>: 5,              <span class="token entity" title="\&quot;">\"</span>max_count<span class="token entity" title="\&quot;">\"</span>: 50            }          }"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">"200"</span> <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span>    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$SNAPSHOT_NAME</span>-snapshots snapshot policy has been created."</span><span class="token keyword">fi</span><span class="token builtin class-name">echo</span> <span class="token string">"sleep forever"</span><span class="token function">sleep</span> infinity<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€ç»ˆçš„ESé…ç½®æ–‡ä»¶ä¸ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apiVersion: elasticsearch.k8s.elastic.co/v1kind: Elasticsearchmetadata:  name: elasticspec:  nodeSets:    - name: default      count: <span class="token number">1</span>      config:        action.destructive_requires_name: <span class="token boolean">true</span>        cluster.max_shards_per_node: <span class="token number">4000</span>      volumeClaimTemplates:        - metadata:            name: elasticsearch-data          spec:            accessModes: <span class="token punctuation">[</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>            storageClassName: premium-rwo            resources:              requests:                storage: 200Gi      podTemplate:        spec:          serviceAccountName: es-backup          volumes:            - name: create-elasticsearch-snapshot-entrypoint <span class="token comment"># å¼•å…¥è„šæœ¬configmap</span>              configMap:                name: create-elasticsearch-snapshot-script                defaultMode: 0744          initContainers:            - name: install-plugins              command:                - <span class="token function">sh</span>                - <span class="token parameter variable">-c</span>                - <span class="token operator">|</span>                  bin/elasticsearch-plugin <span class="token function">install</span> <span class="token parameter variable">--batch</span> repository-gcs          containers:            - name: elasticsearch              resources:                requests:                  memory: 6Gi                  cpu: 2000m                limits:                  memory: 8Gi                  cpu: 4000m            - name: create-elasticsearch-snapshot <span class="token comment"># åˆ›å»ºä»»åŠ¡è„šæœ¬é…ç½®</span>              image: curlimages/curl:8.2.1              command:                - <span class="token function">sh</span>                - <span class="token parameter variable">-c</span>                - <span class="token function">sh</span> /usr/local/bin/create_elasticsearch_snapshot.sh              env:                - name: ES_URL                  value: <span class="token string">"http://localhost:9200"</span>                - name: ES_USERNAME                  value: <span class="token string">"elastic"</span>                - name: ES_PASSWORD                  valueFrom:                    secretKeyRef:                      name: elastic-subscan-es-elastic-user                      key: elastic                - name: BUCKET                  value: <span class="token string">"es-backup"</span>                - name: BASE_PATH                  value: <span class="token string">"staging"</span>                - name: SNAPSHOT_NAME                  value: <span class="token string">"test"</span>                - name: SCHEDULE                  value: <span class="token string">"0 0 14 * * ?"</span> <span class="token comment"># æ¯å¤©14ç‚¹æ‰§è¡Œ</span>              volumeMounts:                - name: create-elasticsearch-snapshot-entrypoint                  mountPath: /usr/local/bin/create_elasticsearch_snapshot.sh                  subPath: entrypoint.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ç¡®ä¿ ES æ•°æ®å¤‡ä»½å®‰å…¨çš„åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†å¤‡ä»½æ•°æ®ç”¨äºæµ‹è¯•å’Œå¼€å‘ç¯å¢ƒã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ GCS å­˜å‚¨æ¡¶ä¸­è®¾ç½®ç”Ÿå‘½å‘¨æœŸè§„åˆ™ä»¥è‡ªåŠ¨åˆ é™¤æ—§å¤‡ä»½ï¼Œä»è€ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> devops </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jså‹ç¼©å¯¼è‡´çš„BUG</title>
      <link href="//post/js-ya-suo-dao-zhi-de-bug.html"/>
      <url>//post/js-ya-suo-dao-zhi-de-bug.html</url>
      
        <content type="html"><![CDATA[<h2 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h2><p>åŸºäºgin-vue-adminé¡¹ç›®å¼€å‘äº†ä¸€ä¸ªåå°ç®¡ç†é¡¹ç›®ï¼Œåœ¨ä¸Šçº¿åä¸€ç›´æŒºå¥½çš„ï¼Œä½†æ˜¯æœ€è¿‘ä¸€æ®µæ—¶é—´æ€»æ˜¯å‡ºç°å„ç§é—®é¢˜ï¼Œ æ¯”å¦‚ç™»å½•æˆåŠŸåç™½å±ã€åˆ‡æ¢è·¯ç”±ä¹‹åç™½å±ä»¥åŠåŠ¨æ€åˆ‡æ¢è·¯ç”±æ˜¾ç¤ºé”™è¯¯ã€‚<br>è¿™äº›é—®é¢˜éå¸¸å¥‡æ€ªï¼Œåœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸€åˆ‡æ­£å¸¸ï¼Œåªè¦ä¸Šäº†æœåŠ¡å™¨å°±æœ‰é—®é¢˜ã€‚</p><h2 id="Debugè¿‡ç¨‹"><a href="#Debugè¿‡ç¨‹" class="headerlink" title="Debugè¿‡ç¨‹"></a>Debugè¿‡ç¨‹</h2><ol><li>é¦–å…ˆæƒ³åˆ°çš„æ˜¯çº¿ä¸Šbuildçš„å‰ç«¯nodeç‰ˆæœ¬ä¸æœ¬åœ°nodeç‰ˆæœ¬ä¸åŒï¼Œå¼€å‘ç¯å¢ƒä½¿ç”¨çš„æ˜¯16.17.0ï¼ŒæœåŠ¡å™¨ä¸­ä½¿ç”¨çš„æ˜¯16.æ‰€ä»¥å°±å…ˆå°†æœåŠ¡å™¨ä¸­çš„nodeç‰ˆæœ¬é™çº§åˆ°16.17.0ï¼Œä½†æ˜¯é—®é¢˜ä¾æ—§ã€‚</li><li>åœ¨æŸ¥çœ‹æœåŠ¡å™¨ç‰ˆæœ¬çš„æŠ¥é”™ä¿¡æ¯ä¹‹åå‘ç°æ˜¯æŸä¸ªjså‡ºç°äº†é”™è¯¯ï¼š<code>o.exports=a(1.valueOf)o.exports=a(1.valueOf)</code> è¿™è¡Œä»£ç å¯¼è‡´çš„é—®é¢˜ï¼Œäºæ˜¯å¯¹æ¯”æœåŠ¡å™¨ä¸Šæ–‡ä»¶ä»¥åŠæœ¬åœ°æ–‡ä»¶å‘ç°äº†é—®é¢˜ï¼Œæœ¬åœ°æ–‡ä»¶æ˜¯<code>o.exports=a(1 .valueOf)</code>ï¼ŒæœåŠ¡å™¨æ–‡ä»¶æ˜¯<code>o.exports=a(1.valueOf)</code>ï¼Œç¼ºå°‘äº†ä¸€ä¸ªç©ºæ ¼ï¼Œéšå³è”æƒ³åˆ°æ˜¯cloudflareçš„jså‹ç¼©å¯¼è‡´çš„é—®é¢˜ã€‚</li><li>å°è¯•å…³é—­cloudflare auto minifyåŠŸèƒ½åå†æ¬¡å°è¯•ï¼Œé—®é¢˜è§£å†³ã€‚</li><li>ä½†è¿™ä¹Ÿä¸æ˜¯åŠæ³•ï¼Œå†ç»™cloudflareåé¦ˆçš„åŒæ—¶ï¼Œéœ€è¦ç»§ç»­æŸ¥å‡ºä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œ äºæ˜¯åœ¨é¡¹ç›®ä¸­æœç´¢<code>1 .valueOf</code>ç±»ä¼¼çš„ä»£ç ï¼Œå‘ç°äº†<code>1..valueOf</code>è¿™æ ·çš„ä»£ç ï¼Œåº”è¯¥å°±æ˜¯è¿™ä¸ªé—®é¢˜å¯¼è‡´äº†</li><li>è¯¥ä»£ç åœ¨<a href="https://github.com/flipped-aurora/gin-vue-admin/blob/main/server/resource/page/js/chunk-vendors.2e7c88f1.js">chunk-vendors.2e7c88f1.js</a>ä¸­ï¼Œä½†æ˜¯ç”±äºä½œè€…æ²¡æœ‰å†™ä¸Šä»»ä½•å…³äºè¯¥æ–‡ä»¶çš„æ¥æºï¼ˆæ²¡æœ‰ç‰ˆæœ¬å·ã€commit hashï¼‰ï¼Œä½†æ˜¯å¯ä»¥äº†è§£åˆ°è¿™æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ã€‚</li><li>é‚£ä¹ˆä¸ºä»€ä¹ˆ<code>1..valueOf</code>ä¼šè¢«æ”¹æˆ<code>1 .valueOf</code>è¿™æ ·äº†ï¼Ÿåªæœ‰ä¸€ç§å¯èƒ½é‚£å°±æ˜¯åˆè¢«å‹ç¼©äº†ï¼Œäºæ˜¯å‘ç°äº†<a href="https://github.com/flipped-aurora/gin-vue-admin/blob/main/server/resource/page/js/chunk-vendors.2e7c88f1.js">chunk-vendors.2e7c88f1.js</a>æ ¹æœ¬æ²¡æœ‰ç›´æ¥è¾“å‡ºï¼Œè€Œæœ€å<code>1 .valueOf</code>ä»£ç æ˜¯ç”±viteç”Ÿæˆçš„äºæ˜¯ä¸Šé¢çš„debugæ­¥éª¤ä½œåºŸã€‚</li><li>äºæ˜¯å‘ç°äº†<a href="https://cn.vitejs.dev/config/build-options.html#build-minify">https://cn.vitejs.dev/config/build-options.html#build-minify</a> æ–‡æ¡£ä¸­æ˜¾ç¤ºé»˜è®¤ä½¿ç”¨äº†esbuildæ¥å‹ç¼©æ–‡ä»¶ï¼Œäºæ˜¯å°è¯•ç€ä½¿ç”¨terseræ¥å‹ç¼©æ–‡ä»¶ï¼Œé—®é¢˜è§£å†³ã€‚</li></ol><p>æœ€ååæ§½ä¸€ä¸‹jsçš„è¯­æ³•éƒ½æ˜¯ä»€ä¹ˆç¥æ“ä½œï¼Œ<code>1 .valueOf</code>è¿™æ ·çš„ä¸œè¥¿éƒ½èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œå‰ç«¯éš¾åšå•ŠğŸ˜¯</p>]]></content>
      
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to install the Velero backup application on GKE</title>
      <link href="//post/shi-yong-velero-bei-fen-gke-ji-qun.html"/>
      <url>//post/shi-yong-velero-bei-fen-gke-ji-qun.html</url>
      
        <content type="html"><![CDATA[<h3 id="Versions"><a href="#Versions" class="headerlink" title="Versions"></a>Versions</h3><ul><li>velero: v1.9.0</li><li>gke: v1.25.6-gke.200</li><li>velero helm charts: 2.30.1</li><li>flux cd: 0.36.0</li></ul><h3 id="Import-helm-chart-repository"><a href="#Import-helm-chart-repository" class="headerlink" title="Import helm chart repository"></a>Import helm chart repository</h3><ul><li>Create vmware-tanzu-helmrepo.yaml, add the following content and submit it to the git repository:</li></ul><pre class="line-numbers language-none"><code class="language-none">apiVersion: source.toolkit.fluxcd.io/v1beta2kind: HelmRepositorymetadata:  name: vmware-tanzuspec:  interval: 30m  url: &lt;https://vmware-tanzu.github.io/helm-charts&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Check if the helmrepo is working fine: <code>kubectl get helmrepository -A | grep vmware-tanzu</code>. The output should be as follows:</li></ul><pre class="line-numbers language-none"><code class="language-none">flux-system   vmware-tanzu           &lt;https://vmware-tanzu.github.io/helm-charts&gt;            117d   True    stored artifact for revision 'eff1284a69fc7293ad2a4618c30d63ef6f486bd74ea3a8d3301866b899facdf6'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Install-velero"><a href="#Install-velero" class="headerlink" title="Install velero"></a>Install velero</h3><ul><li>Create velero-release.yaml, add the following content and submit it to the git repository:</li></ul><pre class="line-numbers language-none"><code class="language-none">apiVersion: helm.toolkit.fluxcd.io/v2beta1kind: HelmReleasemetadata:  name: velerospec:  chart:    spec:      chart: velero      sourceRef:        kind: HelmRepository        name: vmware-tanzu        namespace: flux-system      version: "2.30.1"  interval: 1h  maxHistory: 3  values:    backupsEnabled: false    snapshotsEnabled: true # Enable VolumeSnapshotLocation    deployRestic: true # If you need to use restic to back up PVC data, you need to enable this option    restic: # It is recommended to increase the default resource limits, otherwise backup may fail due to insufficient resources      resources:        requests:          cpu: 1000m          memory: 2Gi        limits:          cpu: 2000m          memory: 4Gi    configuration:      provider: gcp # Introduce GCP      features: "EnableUploadProgress" # Enable upload progress    initContainers: # Introduce GCP plugins      - name: velero-plugin-for-gcp        image: velero/velero-plugin-for-gcp:v1.4.1        imagePullPolicy: IfNotPresent        volumeMounts:          - mountPath: /target            name: plugins    credentials:      useSecret: false # We use workload identity    serviceAccount:      server:        create: true        name: velero        annotations: # Use GKE's workload identity and remember to give GCS permissions          iam.gke.io/gcp-service-account: &lt;service-account-name&gt;@&lt;project-name&gt;.iam.gserviceaccount.com    rbac:      create: true      clusterAdministrator: true    schedules: {}    resources:      requests:        cpu: 100m        memory: 500Mi      limits:        cpu: 1000m        memory: 1000Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>Wait for fluxcd to automatically deploy velero. If the following pod appears, the installation is successful:</p><p><img src="https://s1.ax1x.com/2023/03/11/ppuHcX6.png" alt="https://s1.ax1x.com/2023/03/11/ppuHcX6.png"></p></li><li><p>Check if the CRD is created successfully: <code>kubectl get crd | grep velero</code>. The output should be as follows:</p><p><img src="https://s1.ax1x.com/2023/03/11/ppuHR0O.png" alt="https://s1.ax1x.com/2023/03/11/ppuHR0O.png"></p></li></ul><h3 id="Test-backup"><a href="#Test-backup" class="headerlink" title="Test backup"></a>Test backup</h3><ul><li>Create a test pod and PVC and deploy:</li></ul><pre class="line-numbers language-none"><code class="language-none">apiVersion: v1kind: PersistentVolumeClaimmetadata:  name: test-backup-volume-claim  namespace: stagingspec:  storageClassName: test-backup-storage-class  accessModes:    - ReadWriteOnce  resources:    requests:      storage: 1Gi---apiVersion: v1kind: Podmetadata:  name: test-backup  namespace: staging  labels:    app: test-backupspec:  containers:    - name: test-backup      image: nginx      volumeMounts:        - mountPath: "/var/www/html"          name: mypd  volumes:    - name: mypd      persistentVolumeClaim:        claimName: test-backup-volume-claim<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Write file data to <code>/var/www/html</code> in the pod.</li><li>Create a backup plan:</li></ul><pre class="line-numbers language-none"><code class="language-none">apiVersion: velero.io/v1kind: Schedulemetadata:  name: test-backup  namespace: velerospec:  schedule: "0 14 * * 1"  template:    includedNamespaces:      - staging    volumeSnapshotLocations: [default]    storageLocation: default    includedResources:      - "*"    labelSelector:      matchLabels:        app: test-backup    snapshotVolumes: true    defaultVolumesToRestic: true    ttl: 168h # 7 days<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Create a backup based on the schedule: <code>velero backup create --from-schedule test-backup</code>. The return value is as follows:</li></ul><pre class="line-numbers language-none"><code class="language-none">Creating backup from schedule, all other filters are ignored.Backup request "test-backup-20230314070438" submitted successfully.Run `velero backup describe test-backup-20230314070438` or `velero backup logs test-backup-20230314070438` for more details.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>Use <code>velero backup describe test-backup-20230314070438 --details</code> to check the task status.</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> devops </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How to fix the &quot;no matches for kind &quot;PodSecurityPolicy&quot; in version &quot;policy/v1beta1&quot; error in Grafana</title>
      <link href="//post/grafana-no-matches-for-kind-podsecuritypolicy-error.html"/>
      <url>//post/grafana-no-matches-for-kind-podsecuritypolicy-error.html</url>
      
        <content type="html"><![CDATA[<p>After upgrading the cluster to Kubernetes 1.25, if Grafana was deployed previously with <code>rbac.spsEnabled=true</code> enabled, the error â€œgrafana no matches for kind â€˜PodSecurityPolicyâ€™ in version â€˜policy/v1beta1â€™â€ will occur. This is because the previously deployed Grafana created a PodSecurityPolicy version of policy/v1beta1, which is no longer supported in Kubernetes 1.25, resulting in an error.</p><p>To resolve this issue, follow these steps:</p><ol><li>Obtain Grafanaâ€™s Secrets</li></ol><pre class="line-numbers language-none"><code class="language-none">&gt; kubectl get secret -n prometheus | grep grafanagrafana                                                      Opaque               3      106dsh.helm.release.v1.grafana.v3                                       helm.sh/release.v1   1      105dsh.helm.release.v1.grafana.v4                                       helm.sh/release.v1   1      105dsh.helm.release.v1.grafana.v5                                       helm.sh/release.v1   1      97d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>Backup sh.helm.release.v1.grafana.v3 | sh.helm.release.v1.grafana.v4 | sh.helm.release.v1.grafana.v5</li></ol><pre class="line-numbers language-none"><code class="language-none">kubectl get secret sh.helm.release.v1.grafana.v3 -n prometheus -o yaml &gt; release.v3.yamlkubectl get secret sh.helm.release.v1.grafana.v4 -n prometheus -o yaml &gt; release.v4.yamlkubectl get secret sh.helm.release.v1.grafana.v5 -n prometheus -o yaml &gt; release.v5.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="3"><li>Delete sh.helm.release.v1.grafana.v3 | sh.helm.release.v1.grafana.v4 | sh.helm.release.v1.grafana.v5</li></ol><pre class="line-numbers language-none"><code class="language-none">kubectl delete secret sh.helm.release.v1.grafana.v3 -n prometheuskubectl delete secret sh.helm.release.v1.grafana.v4 -n prometheuskubectl delete secret sh.helm.release.v1.grafana.v5 -n prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="4"><li>Use fluxctl reconcile grafana helmrelease</li></ol><pre class="line-numbers language-none"><code class="language-none">flux reconcile helmrelease grafana -n prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Check Grafana helmreleaseâ€™s status. If it becomes READY and no errors occur, the problem has been successfully resolved.</p>]]></content>
      
      
      
        <tags>
            
            <tag> devops </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>install fluxcd in k8s 1.25.5</title>
      <link href="//post/install-fluxcd-in-k8s-1-25-5.html"/>
      <url>//post/install-fluxcd-in-k8s-1-25-5.html</url>
      
        <content type="html"><![CDATA[<p>Here are the steps to use Flux CD for GitOps on Kubernetes:</p><ol><li>Install Flux CLI: Use the command <code>brew install fluxcd/tap/flux</code> to install.</li><li>Display Flux CLI version: Use the command <code>flux version</code> to display Flux CLI version information.</li><li>Create a Git repository on GitHub.</li><li>Set the GITHUB_TOKEN environment variable.</li><li>Use the command <code>flux bootstrap github</code> to install Flux CD into the Kubernetes cluster. In the command, specify the GitHub username and repository name, read/write key, branch, and the components to use (including image-reflector-controller and image-automation-controller).</li><li>Wait for the Flux CD Pod to start and complete initialization.</li></ol><p>Note that only with the <code>--components-extra=image-reflector-controller,image-automation-controller</code> parameter can you create pods related to images.</p>]]></content>
      
      
      
        <tags>
            
            <tag> devops </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql error: rec.cc:391 thread </title>
      <link href="//post/mysql-error-rec-cc-391-thread.html"/>
      <url>//post/mysql-error-rec-cc-391-thread.html</url>
      
        <content type="html"><![CDATA[<p>æ­¤é”™è¯¯ä»…åœ¨ MySQL 8.0.30 ç‰ˆæœ¬ä¸­å­˜åœ¨ã€‚è¯·å‚è§ <a href="https://bugs.mysql.com/bug.php?id=107941">https://bugs.mysql.com/bug.php?id=107941</a> bug æŠ¥å‘Šã€‚å‡çº§ MySQL ç‰ˆæœ¬åˆ° 8.0.31 å¯ä»¥è§£å†³æ­¤é”™è¯¯ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> bug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•æ¸…ç† Kubernetes namespace ä¸­çš„ finalizers å¹¶æˆåŠŸåˆ é™¤ argocd namespace</title>
      <link href="//post/ru-he-qing-li-kubernetes-namespace-zhong-de-finalizers-bing-cheng-gong-shan-chu-argocd-namespace.html"/>
      <url>//post/ru-he-qing-li-kubernetes-namespace-zhong-de-finalizers-bing-cheng-gong-shan-chu-argocd-namespace.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨åˆ é™¤ Kubernetes é›†ç¾¤ä¸­çš„èµ„æºæ—¶ï¼Œæˆ‘éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>åˆ é™¤æ‰€æœ‰ <code>deploy</code>ã€‚</li><li>åˆ é™¤æ‰€æœ‰ <code>configmap</code>ã€‚</li><li>åˆ é™¤æ‰€æœ‰ <code>namespace</code>ã€‚</li></ol><p>&nbsp;&nbsp;ç„¶è€Œï¼Œæˆ‘å‘ç°åœ¨åˆ é™¤ <code>namespace</code> æ—¶å‡ºç°äº†é—®é¢˜ã€‚å°è¯•äº†å®˜æ–¹æä¾›çš„å‘½ä»¤<br><code>kubectl delete -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</code><br>ä½†æ˜¯ <code>namespace</code> åˆ é™¤ä»ç„¶è¢«å¡ä½äº†ã€‚æˆ‘æ³¨æ„åˆ°è¯¥ <code>namespace</code> ä¸‹å­˜åœ¨å¤šä¸ª <code>argoproj.io/v1alpha1/applications</code> èµ„æºï¼Œå¹¶ä¸”æ‰€æœ‰èµ„æºéƒ½åŒ…å«ä¸€ä¸ª <code>finalizers</code> å­—æ®µã€‚é€šè¿‡æœç´¢å¼•æ“ï¼Œæˆ‘äº†è§£åˆ°åªæœ‰åˆ é™¤æ‰€æœ‰èµ„æº YAML æ–‡ä»¶ä¸­çš„ <code>finalizers</code> å­—æ®µæ‰èƒ½è§£å†³ <code>namespace</code> åˆ é™¤è¢«å¡ä½çš„é—®é¢˜ã€‚å› æ­¤ï¼Œæˆ‘ç›´æ¥åˆ é™¤äº† <code>finalizers</code> å­—æ®µå¹¶æ›´æ–°äº†æ‰€æœ‰èµ„æºï¼Œç›´åˆ°æ‰€æœ‰èµ„æºéƒ½è¢«ä¿®æ”¹å¥½ä¸ºæ­¢ã€‚æœ€ç»ˆï¼Œ<code>namespace</code> èƒ½å¤Ÿè¢«æˆåŠŸåˆ é™¤ã€‚<br>&nbsp;&nbsp;åœ¨ Kubernetes ä¸­ï¼Œåˆ é™¤æŸäº›èµ„æºæ—¶ï¼Œè¿™äº›èµ„æºå¯èƒ½å…·æœ‰å…³è”çš„å…¶ä»–èµ„æºï¼Œè¿™äº›å…³è”èµ„æºéœ€è¦è¢«æ¸…ç†ï¼Œä»¥ä¾¿èƒ½å¤Ÿé¡ºåˆ©åˆ é™¤è¦åˆ é™¤çš„èµ„æºã€‚å½“æŸä¸ª <code>namespace</code> ä¸­å­˜åœ¨å…³è”èµ„æºæ—¶ï¼Œåˆ é™¤è¯¥ <code>namespace</code> å¯èƒ½ä¼šå¤±è´¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒKubernetes ä¼šåœ¨ <code>namespace</code> å¯¹åº”çš„ <code>finalizers</code> åˆ—è¡¨ä¸­æ·»åŠ ä¸€äº›æ¡ç›®ï¼Œä»¥ç¡®ä¿æ‰€æœ‰å…³è”èµ„æºè¢«æ¸…ç†ï¼Œç„¶åå†åˆ é™¤ <code>namespace</code>ã€‚åœ¨åˆ é™¤ <code>namespace</code> æ—¶ï¼ŒKubernetes ä¼šæ£€æŸ¥ <code>finalizers</code> åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ¡ç›®ï¼Œç¡®ä¿è¿™äº›æ¡ç›®å¯¹åº”çš„æ‰€æœ‰èµ„æºå·²è¢«æ¸…ç†ï¼Œç„¶åæ‰ä¼šç»§ç»­åˆ é™¤ <code>namespace</code>ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> devops </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s PVC Auto Scaling Practice</title>
      <link href="//post/k8s-pvc-zi-dong-kuo-rong-shi-jian.html"/>
      <url>//post/k8s-pvc-zi-dong-kuo-rong-shi-jian.html</url>
      
        <content type="html"><![CDATA[<h2 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h2><p>This practice depends on:</p><ol><li>k8s version &gt;= 1.24</li><li><a href="https://github.com/topolvm/pvc-autoresizer">pvc-autoresizer</a> version &gt;= 0.5.0</li></ol><h2 id="Install-pvc-autoresizer"><a href="#Install-pvc-autoresizer" class="headerlink" title="Install pvc-autoresizer"></a>Install pvc-autoresizer</h2><ol><li>Clone the <a href="https://github.com/topolvm/pvc-autoresizer">pvc-autoresizer</a> repository and checkout version 0.5.0, then build and push the Docker image:</li></ol><pre class="line-numbers language-none"><code class="language-none">git clone &lt;https://github.com/topolvm/pvc-autoresizer&gt; &amp;&amp; git checkout v0.5.0 &amp;&amp; cd pvc-autoresizer &amp;&amp; docker build -t pvc-autoresizer:0.5.0 . &amp;&amp; docker push pvc-autoresizer:0.5.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>Add the pvc-autoresizer Helm repo:</li></ol><pre class="line-numbers language-none"><code class="language-none">helm repo add pvc-autoresizer &lt;https://topolvm.github.io/pvc-autoresizer/&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>Prepare the <code>values.yaml</code> file with the following content:</li></ol><pre class="line-numbers language-none"><code class="language-none"># config from &lt;https://github.com/topolvm/pvc-autoresizer/blob/main/charts/pvc-autoresizer/values.yaml&gt;image:  # image.repository -- pvc-autoresizer image repository to use.  repository: perrorone/pvc-autoresizer  # image.tag -- pvc-autoresizer image tag to use.  # @default -- `{{ .Chart.AppVersion }}`  tag:  v0.5.0controller:  # controller.replicas -- Specify the number of replicas of the controller Pod.  replicas: 1  args:    # controller.args.prometheusURL -- Specify Prometheus URL to query volume stats.    # Used as "--prometheus-url" option    prometheusURL: &lt;you_prometheus_url&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>Install pvc-autoresizer:</li></ol><pre class="line-numbers language-none"><code class="language-none">helm install --create-namespace --namespace pvc-autoresizer pvc-autoresizer pvc-autoresizer/pvc-autoresizer --values ./values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol><li>Check if the installation was successful:</li></ol><pre class="line-numbers language-none"><code class="language-none">kubectl get pod -n pvc-autoresizer | grep pvc-autoresizer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Create-StatefulSet-and-Storage-Class"><a href="#Create-StatefulSet-and-Storage-Class" class="headerlink" title="Create StatefulSet and Storage Class"></a>Create StatefulSet and Storage Class</h2><ol><li>Write the <code>stateful-set.yaml</code> file with the following content:</li></ol><pre class="line-numbers language-none"><code class="language-none">apiVersion: storage.k8s.io/v1kind: StorageClassmetadata:  name: test-pvc-autoresizer  namespace: staging  annotations:    resize.topolvm.io/enabled: "true" # Must be present to auto-scaleparameters:  type: pd-ssdprovisioner: pd.csi.storage.gke.ioreclaimPolicy: RetainvolumeBindingMode: WaitForFirstConsumerallowVolumeExpansion: true---apiVersion: apps/v1kind: StatefulSetmetadata:  name: test-pvc-autoresizer  namespace: stagingspec:  selector:    matchLabels:      app: test-pvc-autoresizer  serviceName: "test-pvc-autoresizer"  replicas: 1  template:    metadata:      labels:        app: test-pvc-autoresizer    spec:      terminationGracePeriodSeconds: 10      containers:        - name: test-pvc-autoresizer          image: perrorone/go-file:v1.0.0          ports:            - containerPort: 80              name: http          livenessProbe:            httpGet:              path: /health              port: http          readinessProbe:            httpGet:              path: /health              port: http          volumeMounts:            - name: test-pvc-data              mountPath: /data          resources:            requests:              cpu: 200m              memory: 300Mi            limits:              cpu: 500m              memory: 500Mi  volumeClaimTemplates:    - metadata:        name: test-pvc-data        annotations:  # Must be present to auto-scale            resize.topolvm.io/storage_limit: 8Gi # Maximum scaling size            resize.topolvm.io/threshold: 20%      spec:        accessModes: [ "ReadWriteOnce" ]        storageClassName: "test-pvc-autoresizer"        resources:          requests:            storage: 1Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>Deploy StatefulSet and Storage Class:</li></ol><pre class="line-numbers language-none"><code class="language-none">kubectl apply -f ./stateful-set.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><ol><li>Enter the pod and check the mounted directory size. You can see that the <code>/data</code> directory is only using 1% of its space:</li></ol><pre class="line-numbers language-none"><code class="language-none">df -h<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>Test automatic scaling by writing a file:</li></ol><pre class="line-numbers language-none"><code class="language-none">dd if=/dev/zero of=1G.file bs=50M count=20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>Check the pvc-autoresizer pod log:</li></ol><p><a href="https://imgse.com/i/ppCS1Zn"><img src="https://s1.ax1x.com/2023/02/27/ppCS1Zn.jpg" alt="ppCS1Zn.jpg"></a></p><ol start="4"><li>Check the mounted directory size again. You can see that the mounted directory has already reached 100% usage: <code>/dev/sdf 975.9M 959.9M 0 100% /data</code></li><li>After waiting for some time, check the mounted directory size again. You can see that it has successfully scaled: <code>/dev/sdf 1.9G 960.4M 1007.4M 49% /data</code>ğŸ˜‹ğŸ˜‹ğŸ˜‹ğŸ˜‹ğŸ˜‹ğŸ˜‹<br><a href="https://imgse.com/i/ppCSQqs"><img src="https://s1.ax1x.com/2023/02/27/ppCSQqs.jpg" alt="ppCSQqs.jpg"></a></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> devops </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redisçš„ä¸€äº›å°çŸ¥è¯†</title>
      <link href="//post/redis-de-yi-xie-xiao-zhi-shi.html"/>
      <url>//post/redis-de-yi-xie-xiao-zhi-shi.html</url>
      
        <content type="html"><![CDATA[<h3 id="Redisæ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯"><a href="#Redisæ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="Redisæ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯"></a>Redisæ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯</h3><ul><li>Stringï¼šå…¶valueå¯ä»¥å‚¨å­˜stringä»¥åŠæ•°å­—ç±»å‹ï¼Œä¸€èˆ¬ç”¨äºå¤æ‚çš„æŠ€æœ¯åŠŸèƒ½ä¸Šã€‚</li><li>Hashï¼šå…¶valueå­˜æ”¾çš„æ˜¯ç»“æ„åŒ–çš„å¯¹è±¡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ“ä½œæŸä¸ªå­—æ®µï¼Œæˆ‘ä½¿ç”¨å®ƒå®ç°è¿‡ç”¨æˆ·è¡Œä¸ºæ•°æ®ç¼“å­˜ä»¥åŠsessionåŠŸèƒ½ã€‚</li><li>Listï¼šç±»ä¼¼Pythonä¸­çš„listæ•°æ®ç±»å‹ï¼Œæˆ‘ä¸€èˆ¬ä½¿ç”¨å®ƒåšæ¶ˆæ¯é˜Ÿåˆ—æˆ–è€…åˆ†é¡µåŠŸèƒ½ã€‚</li><li>Setï¼šè¯¥æ•°æ®ç»“æ„å‚¨å­˜çš„æ˜¯ä¸€ç³»åˆ—æ— åºã€ä¸é‡å¤çš„æ•°æ®ï¼Œè¿˜æä¾›å·®é›†ã€äº¤é›†ç­‰åŠŸèƒ½ã€‚æˆ‘ä½¿ç”¨å®ƒä¸ºçˆ¬è™«å»é‡ä»¥åŠç”¨æˆ·é˜…è¯»è¿‡çš„æ–‡ç« åŠŸèƒ½ã€‚</li><li>Sorted Setï¼šæœ‰åºé›†åˆå‚¨å­˜ä¸€ç³»åˆ—æœ‰åºã€ä¸é‡å¤çš„æ•°æ®ï¼Œå¤§å¤šæ•°åœºæ™¯éƒ½ä½¿ç”¨å®ƒåšä¸€ä¸ªæ¦œå•çš„åŠŸèƒ½ã€‚</li></ul><h3 id="Redisçš„ä¸€äº›ç¼ºç‚¹"><a href="#Redisçš„ä¸€äº›ç¼ºç‚¹" class="headerlink" title="Redisçš„ä¸€äº›ç¼ºç‚¹"></a>Redisçš„ä¸€äº›ç¼ºç‚¹</h3><ul><li>Rediså°†æ‰€æœ‰æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ä»¥ä¾¿åŠ å¿«è®¿é—®çš„é€Ÿåº¦ï¼Œä½†è¿™ä¹Ÿé€ æˆäº†Rediså®¹é‡å—åˆ°ç‰©ç†å†…å­˜å¤§å°çš„é™åˆ¶ï¼Œæ‰€ä»¥Rediså¯¹äºä¸€äº›æµ·é‡æ•°æ®åœºæ™¯æœ‰äº›ä¹åŠ›ã€‚</li><li>Redisçš„åœ¨çº¿æ‰©å®¹æ¯”è¾ƒéº»çƒ¦ã€‚å¦‚æœRedisé›†ç¾¤æ•°é‡åˆ°è¾¾ä¸Šé™æ—¶ï¼Œæ­¤æ—¶åœ¨çº¿æ‰©å®¹æ˜¯ä¸€ä¸ªååˆ†å¤æ‚çš„é—®é¢˜ï¼Œå¤§å¤§æé«˜äº†è¿ç»´çš„æˆæœ¬ã€‚</li></ul><h3 id="Redisçš„è¿‡æœŸç­–ç•¥ä»¥åŠå†…å­˜æ·˜æ±°æœºåˆ¶"><a href="#Redisçš„è¿‡æœŸç­–ç•¥ä»¥åŠå†…å­˜æ·˜æ±°æœºåˆ¶" class="headerlink" title="Redisçš„è¿‡æœŸç­–ç•¥ä»¥åŠå†…å­˜æ·˜æ±°æœºåˆ¶"></a>Redisçš„è¿‡æœŸç­–ç•¥ä»¥åŠå†…å­˜æ·˜æ±°æœºåˆ¶</h3><ul><li>Redisé‡‡ç”¨äº†å®šæ—¶åˆ é™¤+æƒ°æ€§åˆ é™¤çš„æ–¹å¼æ¥åˆ é™¤è¿‡æœŸçš„æ•°æ®ã€‚è¿™é‡Œçš„å®šæ—¶åˆ é™¤ï¼ŒRediså¹¶éå°†æ‰€æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„keyéƒ½éå†ä¸€éï¼Œå¦‚æœè¿™æ ·åšå°†ä¼šæ¶ˆè€—å¤§é‡çš„CPUèµ„æºã€‚Redisé‡‡ç”¨äº†éšæœºæŠ½æ ·ï¼Œå¦‚æœè¢«æŠ½åˆ°çš„keyè¿‡æœŸäº†å°±åˆ é™¤ã€‚ä½†å¦‚æœä»…ä»…æ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¸€äº›æ•°æ®æ°¸è¿œä¸ä¼šè¢«æŠ½åˆ°ã€‚è¿™æ—¶Rediså¼•å…¥äº†æƒ°æ€§åˆ é™¤ï¼Œåœ¨è®¿é—®KEYçš„æ—¶å€™æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸå°±åˆ é™¤ã€‚</li><li>å¦‚æœRedisä»…ä»…é‡‡ç”¨ä¸Šé¢ä¸¤ç§æ–¹å¼æ¥åˆ é™¤æ•°æ®ï¼Œé‚£ä¹ˆåœ¨æç«¯æƒ…å†µä¸‹ä»ç„¶ä¼šæœ‰æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚Redisè¿˜æœ‰å†…å­˜æ·˜æ±°ç­–ç•¥ï¼Œæˆ‘æœ€å¸¸ä½¿ç”¨çš„æ˜¯allkeys-lruã€‚å½“Rediså†…å­˜åˆ°è¾¾ä¸Šé™æ—¶ï¼Œå®ƒä»æ‰€æœ‰keyä¸­å¯»æ‰¾æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„KEYåˆ é™¤ã€‚</li></ul><h3 id="å¤§é‡æ•°æ®æ’å…¥Redisåº”è¯¥æ€ä¹ˆåšï¼Ÿ"><a href="#å¤§é‡æ•°æ®æ’å…¥Redisåº”è¯¥æ€ä¹ˆåšï¼Ÿ" class="headerlink" title="å¤§é‡æ•°æ®æ’å…¥Redisåº”è¯¥æ€ä¹ˆåšï¼Ÿ"></a>å¤§é‡æ•°æ®æ’å…¥Redisåº”è¯¥æ€ä¹ˆåšï¼Ÿ</h3><p>ä½¿ç”¨æ­£å¸¸æ¨¡å¼æ¥æ’å…¥æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ï¼Œè€Œä½¿ç”¨ç®¡é“çš„è¯æŸäº›å®¢æˆ·ç«¯ä¼šè¢«é˜»å¡ï¼Œå¯¼è‡´ä¸èƒ½åœ¨è¿™æœŸé—´æ‰§è¡Œå…¶ä»–çš„å‘½ä»¤ã€‚æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯æ ¹æ®Redisåè®®ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨pipe modeå»æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ã€‚å‚è€ƒ<a href="https://redis.io/docs/reference/patterns/bulk-loading/">Redis Mass Insertion</a>ã€‚</p><h3 id="Redisåˆ†åŒºï¼Ÿ"><a href="#Redisåˆ†åŒºï¼Ÿ" class="headerlink" title="Redisåˆ†åŒºï¼Ÿ"></a>Redisåˆ†åŒºï¼Ÿ</h3><ul><li>Redisçš„åˆ†åŒºæ˜¯æŒ‡å°†æ•°æ®åˆ†å‰²æˆå¤šä¸ªå­é›†ï¼Œåˆ†åˆ«ä¿å­˜åˆ°ä¸åŒçš„Rediså®ä¾‹ä¸­ï¼Œæ¯ä¸€ä¸ªRediså®ä¾‹éƒ½åªä¿å­˜äº†KEYçš„ä¸€ä¸ªå­é›†ã€‚</li><li>Redisçš„åˆ†åŒºåœ¨æ¶‰åŠå¤šä¸ªkeyæ“ä½œçš„æ—¶å€™ï¼Œå¤šæ•°æ˜¯ä¸æ”¯æŒçš„ï¼Œæ›´åˆ«è¯´å¤škeyäº‹åŠ¡æ“ä½œã€‚å¯¹äºå¤‡ä»½çš„æƒ…å†µä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚</li><li>Redisåˆ†åŒºæœ‰ä¸¤ç§ç±»å‹ï¼š<ol><li>æŒ‰ç…§èŒƒå›´åˆ†åŒºï¼Œæ˜ å°„ä¸€å®šèŒƒå›´çš„å¯¹è±¡åˆ°ç‰¹å®šçš„Rediså®ä¾‹ï¼Œä½†è¿™ç§å¹¶ä¸é•¿ä½¿ç”¨ã€‚</li><li>ä½¿ç”¨hashåˆ†åŒºï¼Œå…¶å·¥ä½œåŸç†ä½¿ç”¨äº†hashè¡¨çš„åŸç†ï¼Œç±»ä¼¼Python dictã€‚</li></ol></li></ul><h3 id="Rediså¦‚ä½•åšé›†ç¾¤ï¼Ÿ"><a href="#Rediså¦‚ä½•åšé›†ç¾¤ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•åšé›†ç¾¤ï¼Ÿ"></a>Rediså¦‚ä½•åšé›†ç¾¤ï¼Ÿ</h3><p>æ¨èä½¿ç”¨å®˜æ–¹çš„<a href="https://redis.io/docs/management/scaling/">Redis Cluster</a>ï¼Œå…¶å®ç°åŸç†æ˜¯ï¼šRedisé›†ç¾¤å†…éƒ¨æœ‰2<strong>14ä¸ªå“ˆå¸Œæ§½ã€‚å½“éœ€è¦æ’å…¥keyæ—¶ï¼Œé¦–å…ˆå¯¹keyä½¿ç”¨<a href="https://baike.baidu.com/item/%E5%BE%AA%E7%8E%AF%E5%86%97%E4%BD%99%E6%A0%A1%E9%AA%8C%E7%A0%81/10168758?fr=aladdin&amp;fromtitle=CRC%E6%A0%A1%E9%AA%8C&amp;fromid=3439037">crc16ç®—æ³•</a>è®¡ç®—å‡ºä¸€ä¸ªæ•°å­—ï¼Œåœ¨ç”¨æ­¤æ•°å­—å¯¹2</strong>14å–ä½™ï¼Œè¯¥å–ä½™ç»“æœå°±æ˜¯æ•°æ®å­˜æ”¾çš„å“ˆå¸Œæ§½ä½ç½®ã€‚è€ŒRedisé›†ç¾¤çš„èŠ‚ç‚¹ç®¡ç†è¿™ä½¿ç”¨ç±»ä¼¼å“¨å…µçš„æœºåˆ¶æ¥å®ç°ï¼Œé›†ç¾¤ç±»èŠ‚ç‚¹é€šè¿‡ç›¸äº’pingæ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦èƒ½å¤Ÿè¿æ¥ã€‚å¦‚æœè¿‡åŠæ•°èŠ‚ç‚¹éƒ½è¿æ¥ä¸ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™Redisé›†ç¾¤å°±ä¼šè®¤å®šæ­¤èŠ‚ç‚¹å®•æœºäº†ã€‚è¯¥æ–¹æ¡ˆç¡®å¹¶ä¸èƒ½ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ä¸€å®šä¸è¦å°†Redisä½œä¸ºä¸€ä¸ªé«˜å¯é æ€§çš„å­˜å‚¨æœåŠ¡ä½¿ç”¨ï¼</p><h3 id="Rediså¦‚ä½•åšæŒä¹…åŒ–ï¼Ÿ"><a href="#Rediså¦‚ä½•åšæŒä¹…åŒ–ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•åšæŒä¹…åŒ–ï¼Ÿ"></a>Rediså¦‚ä½•åšæŒä¹…åŒ–ï¼Ÿ</h3><p>Redisæ”¯æŒä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼š</p><ol><li>å¿«ç…§ï¼šé€šè¿‡å¯¹é…ç½®æ–‡ä»¶çš„è®¾ç½®ï¼Œå¯ä»¥ä½¿Redisåœ¨Nç§’ç±»Mä¸ªkeyè¢«ä¿®æ”¹æ—¶å°±å°†å†…å­˜çš„æ•°æ®ä»¥å¿«ç…§çš„æ–¹å¼å†™å…¥åˆ°åç¼€ä¸ºâ€™.rdbâ€™æ–‡ä»¶ä¸­ã€‚</li><li>AOF: æ¯ä¸€æ¬¡æ”¶åˆ°ä¸€æ¬¡å†™çš„å‘½ä»¤å°±å°†æ­¤å‘½ä»¤è¿½åŠ åˆ°åç¼€ä¸ºâ€™.aofâ€™æ–‡ä»¶ä¸­ï¼Œå½“Redisé‡å¯æ—¶ä¼šé€šè¿‡é‡æ–°æ‰§è¡Œæ–‡ä»¶ä¸­ä¿å­˜çš„å†™å‘½ä»¤æ¥åœ¨å†…å­˜ä¸­é‡å»ºæ•´ä¸ªæ•°æ®åº“çš„å†…å®¹ã€‚</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cast Type Conversion Library - Recommended Go Library</title>
      <link href="//post/cast-lei-xing-zhuan-huan-ku-go-ku-tui-jian.html"/>
      <url>//post/cast-lei-xing-zhuan-huan-ku-go-ku-tui-jian.html</url>
      
        <content type="html"><![CDATA[<p>In Go language, type conversion is a frequently used operation, but converting values between different types requires importing different libraries, which can be relatively cumbersome. However, the <code>cast</code> library solves this problem and provides many type conversion functions, usually only requiring the import of this one library.</p><p>The <code>cast</code> library not only provides conversions between common types, such as int to string, but also provides more complex type conversions, such as converting a time string to the <code>time.Time</code> type. In addition, it provides two conversion functions, one only returns the zero value of that type without returning an error, and the other returns an error, so developers can choose to use it according to their actual needs.</p><p>Here are some commonly used APIs:</p><ul><li><code>cast.StringToDate</code>: Converts common time strings to the <code>time.Time</code> type.</li></ul><pre class="line-numbers language-none"><code class="language-none">fmt.Println(cast.StringToDate("2006-01-02 15:04:05"))// output: 2006-01-02 15:04:05 +0000 UTC &lt;nil&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><code>cast.ToBoolSlice</code>: Converts an array of any type to the <code>[]bool</code> type.</li></ul><pre class="line-numbers language-none"><code class="language-none">fmt.Println(cast.ToBoolSlice([]interface{}{1,2,0,true, false}))// output: [true true false true false]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><code>cast.ToBool</code>: Converts any type to the <code>bool</code> type.</li></ul><pre class="line-numbers language-none"><code class="language-none">fmt.Println(cast.ToBool(1)) // output:truefmt.Println(cast.ToBool(0)) // output: falsefmt.Println(cast.ToBool("")) // output: falsefmt.Println(cast.ToBool("0")) // output: falsefmt.Println(cast.ToBool("1")) // output: truefmt.Println(cast.ToBool("true")) // output: truefmt.Println(cast.ToBool("false")) // output: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>cast.ToString</code>: Converts any type to a string type.</li></ul><pre class="line-numbers language-none"><code class="language-none">cast.ToString("mayonegg")         // "mayonegg"cast.ToString(8)                  // "8"cast.ToString(8.31)               // "8.31"cast.ToString([]byte("one time")) // "one time"cast.ToString(nil)        // "nil"var foo interface{} = "one more time"cast.ToString(foo)                // "one more time"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>cast.ToStringMap</code>: Converts a map of any type to <code>map[string]interface{}</code>.</li></ul><pre class="line-numbers language-none"><code class="language-none">fmt.Println(cast.ToStringMap(map[interface{}]interface{}{    1:2,    "2":3,    true:1,})) // output: map[1:2 2:3 true:1]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>More APIs can be found in its documentation: <a href="https://github.com/spf13/cast">https://github.com/spf13/cast</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Understanding Redis SDS</title>
      <link href="//post/sds-xiang-jie.html"/>
      <url>//post/sds-xiang-jie.html</url>
      
        <content type="html"><![CDATA[<p>What is SDS?</p><p>SDS is an abstract type built by Redis, mainly used to store Redisâ€™ default string representation, the AOF buffer in the AOF module, and the client state input buffer.</p><p>Advantages of SDS</p><p>Why doesnâ€™t Redis use C strings? First, we need to understand the shortcomings of C strings:</p><ol><li>C strings do not record their own length information. Obtaining the length of a string requires traversing the entire string, with a time complexity of O(n).</li><li>C strings do not record their own length, and a slight mistake can cause a buffer overflow.</li><li>For cache-type databases like Redis, the value of the cache often changes frequently. However, each growth or reduction of a C string requires a memory reallocation operation.</li><li>The content cached in the Redis database is not specific, and it may be binary data such as images or audio files. However, the characters in C strings must comply with a certain encoding, and the strings cannot contain spaces. These restrictions also mean that Redis cannot use C strings as its own string implementation.</li></ol><p>SDS eliminates all these shortcomings one by one:</p><ol><li>SDS records its own length information, making the time complexity of obtaining the string length O(1).</li><li>SDS uses pre-allocated space and lazy space release algorithms to solve the problem of frequent memory allocation operations.</li><li>Since SDS saves its own length, SDS will not determine the end of the string like C does according to â€˜\0â€™.</li></ol><p>Implementation of SDS</p><p>Redis uses the sdshdr structure to represent SDS values:</p><pre class="line-numbers language-none"><code class="language-none">struct sdshdr{   int len; // Records the number of bytes used in the buf array   int free; // Records the number of unused bytes in buf   char buf[]; // Save the array of strings}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>SDS follows the convention of C strings ending with a null character so that functions in C strings can be reused. This null character at the end of the string does not increase the value of the len field. For example, if you need to use SDS to save the string â€œgolang,â€ the SDS corresponding to the structure is:</p><p><img src="https://s1.ax1x.com/2022/03/25/qNgzqI.png" alt="https://s1.ax1x.com/2022/03/25/qNgzqI.png"></p><p>Since SDS records its own length, getting the length of the string in Redis only needs to return the len field, and its time complexity is O(1). The space allocation strategy of SDS completely eliminates the possibility of buffer overflow, which frequently occurs in C strings. When Redis needs to modify an SDS string, it first checks whether the space of the SDS satisfies the space required for the modification. If it does not meet the requirements, the space of the SDS will be expanded to meet the capacity required for the modification. The SDS space expansion algorithm is as follows:</p><ol><li>If the length of the SDS after modification is less than 1MB, the program will allocate unused space of the same size as the len field value. For the example above, the total capacity of the SDS is 6 (len) + 6 (free) + 1 (â€˜\0â€™) = 13 bytes.</li><li>If the length of the SDS after modification is greater than 1MB, the SDS will allocate 1MB of unused space. If the capacity of an SDS after the len value is modified is 2MB, Redis will allocate 1MB of unused space for the SDS. At this time, the total capacity of the SDS is 2MB (len) + 1MB (len) + 1byte (â€˜\0â€™) = 3073 byte capacity.</li></ol><p>This expansion algorithm reduces the frequency of requesting memory from the system. The SDS space release is not real-time but lazy: Redis believes that if the capacity of an SDS reaches N, it is likely to reach N after it is reduced. And lazy release also reduces the possibility of the next memory allocation. If there is a â€œgolangâ€ string stored in Redis now, and we need to modify â€œgolangâ€ to â€œgo,â€ then the SDS structure of Redis will be like this:</p><p><img src="https://s1.ax1x.com/2022/03/25/qN2RTP.png" alt="https://s1.ax1x.com/2022/03/25/qN2RTP.png"></p><p><img src="https://s1.ax1x.com/2022/03/25/qN24fS.png" alt="https://s1.ax1x.com/2022/03/25/qN24fS.png"></p><p>SDS provides an API to clean up memory. We can call this API when needed to release memory.</p><p>Summary</p><ol><li>Redis only uses C strings as literals, and SDS is used to represent most strings.</li><li>The length of the string can be obtained with constant time complexity.</li><li>Eliminates buffer overflow.</li><li>Reduces the number of times memory needs to be reallocated for strings. And for binary data security, it is compatible with some C string functions.</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Explanation of Go channels</title>
      <link href="//post/go-de-channel-xiang-jie.html"/>
      <url>//post/go-de-channel-xiang-jie.html</url>
      
        <content type="html"><![CDATA[<p>This article is based on the analysis of the source code of version golang 1.12.1, where the chan source code is located in the file go/src/runtime/chan.go.</p><h2 id="What-is-a-Channel"><a href="#What-is-a-Channel" class="headerlink" title="What is a Channel?"></a>What is a Channel?</h2><p>In the source code, a channel is actually a structure, with the following structure:</p><pre class="line-numbers language-none"><code class="language-none">type hchan struct {    qcount uint // the number of data in the queue    dataqsiz uint // the size of the circular queue    buf unsafe.Pointer // the element array that stores the data    elemsize uint16    closed uint32    elemtype *_type // the type of the element    sendx uint // the number of sends    recvx uint // the number of receives    recvq waitq // the structure to put the receiver when blocking    sendq waitq // the structure to put the sender when blocking    // Used to ensure concurrent safety of data    lock mutex}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>sendx</code> and <code>recvx</code> need to be incremented each time data is read or written. The roles of <code>recvq</code> and <code>sendq</code> are to store the channel structures of the receiver or sender when the buffer is full.</p><h2 id="Creating-a-Channel"><a href="#Creating-a-Channel" class="headerlink" title="Creating a Channel"></a>Creating a Channel</h2><p>To create a channel, we use the <code>make</code> function, which actually calls the <code>makechan</code> function to create the channel. The function signature is as follows:</p><pre class="line-numbers language-none"><code class="language-none">func makechan(t *chantype, size int) *hchan<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><code>T</code> is the type of data to be sent or received by the channel, and <code>size</code> is the second parameter of the <code>make</code> function, which specifies the buffer size of the channel. By default, it is 0, indicating an unbuffered channel. The function returns a pointer to the <code>hchan</code> structure. When creating a channel, the size of <code>t</code> is first checked. If it exceeds 65536 bytes, an error will be triggered. If the size of the data type passed through the channel meets the requirements, a memory space of a certain capacity will be created according to the characteristics of the <code>t</code> type, and this memory space will be copied to <code>buf</code>. It is worth mentioning that there is a variable called <code>debugChan</code> in the <code>chan</code> package, which is set to <code>false</code> by default. When it is set to <code>true</code>, some debug information will be printed when operating on the channel. This will help us quickly discover bugs caused by the channel.</p><h2 id="Sending-Data-to-a-Channel"><a href="#Sending-Data-to-a-Channel" class="headerlink" title="Sending Data to a Channel"></a>Sending Data to a Channel</h2><p>Sending data to a channel is implemented by the <code>chansend</code> function at <a href="https://github.com/golang/go/blob/master/src/runtime/chan.go#71">chan.go:142</a>. The function first checks whether the current channel is nil and whether it is a buffered channel. If it is, it returns directly. If it is an unbuffered channel, it calls the <code>gopark</code> function at <code>proc.gp:284</code> to set the current goroutine to a waiting state. It then checks whether the channel is ready to receive data. If it is, it calls the <code>send</code> function at <code>chan.go:264</code> to send the data. The main function of <code>send</code> is to <code>copy</code> the data to be sent to <code>buf</code>. If the current channel is unbuffered, it locks the current goroutine by calling <code>lock</code>. After the current data is received, it calls <code>goready</code> to notify the runtime that the current goroutine is ready to run again. If the channel is buffered, it returns directly.</p><h2 id="Receiving-Data-from-a-Channel"><a href="#Receiving-Data-from-a-Channel" class="headerlink" title="Receiving Data from a Channel"></a>Receiving Data from a Channel</h2><p>Receiving data is actually the same as sending data, except that when the channel is buffered and no data has been sent to the channel, it directly stores the address of the variable that receives the chan data into the <code>sendq</code> structure. When there is data to be sent, if it finds data in <code>recvq</code>, it directly stores the data into the address in this structure instead of using <code>buf</code> to <code>copy</code> the data.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The channel uses the <code>copy buf</code> method to communicate and ultimately implements sharing memory through communication. When a goroutine is blocked, the system thread puts it into the <code>hchan.sendq</code> or <code>hchan.recvq</code> list. The <code>sudog</code> type structure in this list is the current goroutine, and this <code>sudog</code> structure contains a variable that holds a pointer to the channel. Previously, I only used chan without knowing its principle. After reading the source code, I understood the parts that I did not understand before. When writing this article, I followed the source code, so there may be some contradictions in the order.</p>]]></content>
      
      
      
        <tags>
            
            <tag> golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python IO Multiplexing Practice</title>
      <link href="//post/io-duo-lu-fu-yong-shi-jian.html"/>
      <url>//post/io-duo-lu-fu-yong-shi-jian.html</url>
      
        <content type="html"><![CDATA[<p>In the past few days, I have been studying the Tornado source code and found that although Tornado claims to use an asynchronous model, it actually implements an event loop using IO multiplexing. To deepen my understanding of IO multiplexing, I decided to implement a simple HTTP client myself to compare the performance difference between synchronous and IO multiplexing clients.</p><p>Without further ado, letâ€™s first take a look at the most intuitive difference between synchronous and IO multiplexing clients. First, letâ€™s use Tornado to implement a simple server:</p><pre class="line-numbers language-none"><code class="language-none"># -*- coding:utf-8 -*-from tornado.web import RequestHandler, Applicationfrom tornado.ioloop import IOLoopimport tornado.genclass TestHandle(RequestHandler):    async def get(self, *args, **kwargs):        await tornado.gen.sleep(1)        self.write("OK")if __name__ == '__main__':    app = Application([('/', TestHandle)])    app.listen(8080)    IOLoop.current().start()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>We pause the server for 1 second when processing requests so that it is more convenient to observe the difference between the two client implementations. Next, letâ€™s implement a synchronous client:</p><pre class="line-numbers language-none"><code class="language-none"># -*- coding:utf-8 -*-import socketimport timeREQUEST_STR = '{method} {path} HTTP/1.0\r\n\r\n'def block_client(hostname, port, method, path):    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)    sock.connect((hostname, port))    sock.send(REQUEST_STR.format(method=method, path=path).encode())    response_body = []    while True:        response_stream = sock.recv(1024)        if not response_stream:            return b"".join(response_body).decode()        response_body.append(response_stream)if __name__ == '__main__':    count = 3    start_time = time.time()    for _ in range(3):        block_client("127.0.0.1", port=8080, method="GET", path="/")    print("{} requests {} times, running time: {:.1f} seconds".format(block_client.__name__, count, time.time() - start_time))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Start the server and test how long it takes for the synchronous client to request the server:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; C:\Users\Administrator&gt;python client.pyblock_client requests 3 times, running time: 3.0 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>As expected, it takes a total of 3 seconds to make three requests because the server paused for 1 second. Next, letâ€™s implement an IO multiplexing client and see how it performs:</p><pre class="line-numbers language-none"><code class="language-none">from selectors import DefaultSelector, EVENT_WRITE, EVENT_READimport socketimport timeREQUEST_STR = '{method} {path} HTTP/1.0\r\n\r\n'JOBS_COUNT = 0select = DefaultSelector()class NoBlockClient:    def __init__(self):        self.result = []    def request(self, method, hostname, port, path):        global JOBS_COUNT        JOBS_COUNT += 1        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)        sock.setblocking(False)        try:            sock.connect((hostname, port))        except BlockingIOError:            pass        select.register(sock.fileno(), EVENT_WRITE, partial(self._send, sock, method, path))    def _send(self, sock, method, path):        select.unregister(sock.fileno())        sock.send(REQUEST_STR.format(method=method, path=path).encode())        select.register(sock.fileno(), EVENT_READ, partial(self._recv, sock))    def _recv(self, sock):        global JOBS_COUNT        response_stream = sock.recv(1024)        if not response_stream:            select.unregister(sock.fileno())            sock.close()            JOBS_COUNT -= 1        else:            self.result.append(response_stream)    def run(self):        while JOBS_COUNT:            events = select.select()            for key, mask in events:                callback = key.data                callback()        return self.resultstart_time = time.time()count = 3no_block_client = NoBlockClient()for _ in range(count):    no_block_client.request("GET", "127.0.0.1", 8080, "/")result = no_block_client.run()print("{} requests {} times, running time: {:.1f} seconds".format(NoBlockClient.__name__, count, time.time() - start_time))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Run the client:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; C:\Users\Administrator&gt;python no_block_client.pyNoBlockClient requests 3 times, running time: 1.0 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>The difference in time is very obvious. Although the code looks particularly complicated, to put it bluntly, each function corresponds to an event registered in select. select monitors these events and runs the corresponding function if an event is triggered.</p><p>Letâ€™s analyze the IO multiplexing client code:</p><ol><li><code>select = DefaultSelector()</code> This line of code returns the best implementation of IO multiplexing on the current platform, which are select, poll, epoll, dev/poll, and kqueue. Since I am testing on Windows, DefaultSelector() returns the select model.</li><li>The purpose of the <code>NoBlockClient.request</code> function is to create a non-blocking socket connection to the target server and register the current socket in select. When its status is writable, the NoBlockClient._send function is called, which is equivalent to a callback function.</li><li><code>NoBlockClient._send</code> is responsible for sending the message to the connected server, and finally, it registers the event to select like NoBlockClient.request does.</li><li><code>NoBlockClient._recv</code> is called when the registered event is readable. It reads the returned data from the server, and the complete request is finished.</li><li>The <code>NoBlockClient.run</code> function is mainly used to let select start looping to monitor the status of these registered events and run callback functions.</li></ol><p>The selectors module is a encapsulation of the select module, so we donâ€™t have to worry about what model is needed on the current platform. It directly returns the best model for the current platform and integrates the APIs of various models to make it easier for users to write cross-platform code. The most commonly used models include select, poll, and epoll. Next, we will explain the differences, advantages, and disadvantages of these models, as well as their implementation methods.</p><ol><li>select: select puts the registered events into a list and copies them to the kernel space for monitoring. If one of these events changes, select will copy the list containing the events back to the user space, resulting in a huge waste of resources. If select needs to monitor more and more events, its performance will decrease linearly. Moreover, when select copies the time to the user space, it does not tell the user which event was triggered, but requires the user to traverse them by themselves. Since the more events select monitors, the worse the performance, the system kernel usually limits the number of events that the select model can monitor. In the Python source code (<a href="https://github.com/python/cpython/blob/master/Modules/selectmodule.c">github: selectmodule.c</a>), the number of events that select can monitor in Windows is limited to 512 using macro definitions. Of course, the biggest advantage of select is that it is supported by almost all platforms.</li><li>poll: The implementation method of poll is almost the same as that of select, so I wonâ€™t go into details. See <a href="https://blog.csdn.net/luojian5900339/article/details/54581852">Poll event mechanism</a> for details.</li><li>epoll: Compared with select and poll, epoll has undergone a qualitative change. Epoll inserts the registered events into a red-black tree, and each node in the red-black tree is a registered event. Because the time complexity of querying, inserting, and deleting a red-black tree is O(logn), epoll can manage events more conveniently, and it only returns the triggered events when an event is triggered, rather than all events, which greatly increases efficiency. For a more detailed introduction to the epoll model, see <a href="https://blog.csdn.net/apacat/article/details/51375950">Understanding and in-depth analysis of EPOLL</a>.</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python dict</title>
      <link href="//post/dict.html"/>
      <url>//post/dict.html</url>
      
        <content type="html"><![CDATA[<p>Pythonâ€™s <code>dict</code> is a mapping type that uses a hash table to store data, making the query speed time complexity O(1), which is a typical data structure that trades space for time.</p><p>When we create a <code>key-value</code> pair, we first apply the hash function to the <code>key</code> to obtain an integer array, take the remainder of this integer with the length of the array that stores the <code>value</code>, and obtain the index where the <code>value</code> is stored. When initializing <code>dict</code>, Python first allocates an array of about 8KB to store <code>value</code> (see the definition of the minimum capacity of the dictionary at line 111 of <code>dictobject.c</code>). If the position of the array is not enough to store it, the system will be asked to allocate an array twice the current capacity to store <code>value</code>.</p><p>For hash conflicts, Python chose to use open addressing to solve the problem: when a hash conflict occurs, the next candidate position is calculated through the probing function. If the next candidate position still has a conflict, continue to search down through the probing function until an empty slot is found to store the element to be inserted.</p><p><code>dict</code> initialization is completed in the function <a href="https://github.com/python/cpython/blob/main/Objects/dictobject.c#L691">dictobject.PyDict_New:691</a>:</p><pre class="line-numbers language-none"><code class="language-none">PyObject * PyDict_New(void){    dictkeys_incref(Py_EMPTY_KEYS);    return new_dict(Py_EMPTY_KEYS, empty_values);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Since Python 3.6, the order of the keys in <code>dict</code> has been maintained in the order of insertion <a href="https://github.com/python/cpython/blob/main/Objects/dictobject.c#L13">dictobject.c:13</a>:</p><pre class="line-numbers language-none"><code class="language-none">As of Python 3.6, this is compact and ordered. Basic idea is described here:* &lt;https://mail.python.org/pipermail/python-dev/2012-December/123028.html&gt;* &lt;https://morepypy.blogspot.com/2015/01/faster-more-memory-efficient-and-more.html&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>The implementation of <code>dict</code> and the method of solving hash conflicts are core issues of Python. Understanding these contents is of great help for Pythonâ€™s performance optimization and underlying implementation.</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python deep copy and shallow copy</title>
      <link href="//post/python-shen-kao-bei-qian-kao-bei.html"/>
      <url>//post/python-shen-kao-bei-qian-kao-bei.html</url>
      
        <content type="html"><![CDATA[<p>When it comes to object copying in Python, we need to understand the difference between is and ==:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; a = [1,2,3,4]&gt;&gt;&gt; b = [1,2,3,4]&gt;&gt;&gt; a == bTrue&gt;&gt;&gt; a is bFalse<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>From the example above, we can see that the values in a and b are equal, but the result of is is different. This is because Python compares whether the values of a and b are equal, while is compares whether the object identities are equal. Therefore, in Python, we usually use == to compare the values of objects and use is to determine whether the values bound to objects are None. It should be noted that some beginners often make the mistake of using None to compare whether a string, list, or dictionary is empty, which is incorrect because these variables are not equal to None in terms of object identity or value.</p><p>In Python, we usually use shallow copy to copy objects. The copy module provides us with the copy (shallow copy) and deepcopy (deep copy) functions.</p><p>Shallow copy refers to copying a reference to the copied object, and the copied object points to the value of the object being copied. In other words, a reference is added to the original value.</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; a = 1&gt;&gt;&gt; b = a&gt;&gt;&gt; id(a)4297636352&gt;&gt;&gt; id(b)4297636352<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Deep copy refers to copying the value of the copied object and creating a new object whose value and object identity are equal to the copied object.</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; import copy&gt;&gt;&gt; a = [1,2,3]&gt;&gt;&gt; b = copy.deepcopy(a)&gt;&gt;&gt; b[1,2,3]&gt;&gt;&gt; a[1,2,3]&gt;&gt;&gt; a == bTrue&gt;&gt;&gt; a is bTrue&gt;&gt;&gt; id(a)4297636352&gt;&gt;&gt; id(b)4297636352&gt;&gt;&gt; a.append(0)&gt;&gt;&gt; a[1,2,3,0]&gt;&gt;&gt; b[1,2,3]&gt;&gt;&gt; b.append(9)&gt;&gt;&gt; b[1, 2, 3, 9]&gt;&gt;&gt; a[1, 2, 3, 0]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Based on this phenomenon, we should pay special attention to the use of mutable parameters as default parameters in functions. If we are not careful, we may encounter the following situation:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; def a(x = []):...     x.append(0)...     print(x)&gt;&gt;&gt; a()[0]&gt;&gt;&gt; a()[0, 0]&gt;&gt;&gt; a()[0, 0, 0]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>To avoid this situation, we should avoid using mutable objects as default function parameters:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; def a(x = None):...     if x is None:...         x = []...     else:...         x.append(0)...     print(x)...&gt;&gt;&gt; a()[]&gt;&gt;&gt; a()[]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>At the same time, when creating a class and passing parameters during initialization, shallow copy is also used to pass parameters, which can lead to the following situation:</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; class A:...     def __init__(self, name):...         self.name = name...     def printf(self):...         print(self.name)...&gt;&gt;&gt; x = [1,2,3,4]&gt;&gt;&gt; a = A(x)&gt;&gt;&gt; a.printf()[1, 2, 3, 4]&gt;&gt;&gt; x.append(5)&gt;&gt;&gt; a.printf()[1, 2, 3, 4, 5]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>When the passed-in parameter changes, the value of the variable in the class will also change, which is difficult to detect. The biggest difference between deep copy and shallow copy is that deep copy will copy the parent object and its sub-objects, while shallow copy only copies the parent object.</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åç«¯ä¼ ç»™å‰ç«¯int ç±»å‹æ•°æ®è‡ªå¢æˆ–è‡ªå‡</title>
      <link href="//post/hou-duan-chuan-gei-qian-duan-int-lei-xing-shu-ju-zi-zeng-huo-zi-jian.html"/>
      <url>//post/hou-duan-chuan-gei-qian-duan-int-lei-xing-shu-ju-zi-zeng-huo-zi-jian.html</url>
      
        <content type="html"><![CDATA[<p>ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯Python 3ï¼ŒPython ä¸­çš„ int ç±»å‹ä¸å…¶ä»–è¯­è¨€ä¸­çš„ int ç±»å‹ä¸åŒï¼ŒPython å°† long ç±»å‹ä¹ŸåŠ å…¥åˆ°äº† int ä¸­ã€‚å› æ­¤ï¼Œåœ¨å…¶ä»–è¯­è¨€ä¸­èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºçš„ int ç±»å‹ï¼Œåœ¨ Python ä¸­ä¸ä¸€å®šèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºã€‚å½“ Python ä¼ é€’çš„ int è¶…è¿‡äº†æµè§ˆå™¨æ‰€èƒ½è§£æçš„æœ€å¤§å€¼æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚å»ºè®®å°†è¾ƒå¤§çš„ int ç±»å‹è½¬æ¢æˆå­—ç¬¦ä¸²åå†ä¼ ç»™å‰ç«¯ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> bug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonå†…ç½®å‡½æ•°</title>
      <link href="//post/python-nei-zhi-han-shu.html"/>
      <url>//post/python-nei-zhi-han-shu.html</url>
      
        <content type="html"><![CDATA[<p>abs(x): æ¥å—ä¸€ä¸ªæ•´æ•°æˆ–æµ®ç‚¹æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›è¯¥å‚æ•°çš„ç»å¯¹å€¼ï¼Œå¦‚æœè¯¥å‚æ•°æ˜¯ä¸€ä¸ªå¤æ•°ï¼Œåˆ™è¿”å›å¤æ•°çš„æ¨¡ã€‚</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; abs(-1)1&gt;&gt;&gt; abs(4 - 8j)8.94427190999916<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>all(iter): æ¥å—ä¸€ä¸ªå¯è¿­ä»£ç±»å‹ï¼Œå¦‚æœè¯¥å‚æ•°å†…æ‰€æœ‰å…ƒç´ ä¸ºçœŸè¿”å›Trueï¼Œå¦åˆ™è¿”å›Falseã€‚</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; all([1,2,3,4,5])True&gt;&gt;&gt; all([1,2,3,4,0])False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>any(iter):æ¥å—ä¸€ä¸ªå¯è¿­ä»£ç±»å‹ä¸ºå‚æ•°,å¦‚æœè¯¥å‚æ•°å†…ä»»ä½•å…ƒç´ ä¸ºçœŸ,åˆ™è¿”å›True,å¦åˆ™è¿”å›False.</p><pre class="line-numbers language-none"><code class="language-none">&gt;&gt;&gt; any([0, 0,1])True&gt;&gt;&gt; any([0, 0,0])False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>asicc(object):æ¥å—ä¸€ä¸ªå¯¹è±¡, å°†è°ƒç”¨è¯¥å¯¹è±¡çš„__repr__æ–¹æ³•, è¿”å›çš„å­—ç¬¦ä¸²ä¼šå°†\x,\u,\Uè¿›è¡Œè½¬ç§»è¾“å‡º.</p><pre class="line-numbers language-none"><code class="language-none">In [4]: class a:...:     def __repr__(self):...:         return "repr"In [5]: ascii(a())Out[5]: 'repr'In [9]: ascii("\n\rfdsafdsa")Out[9]: "'\\n\\rfdsafdsa'"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bin(x):æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°, å¹¶å°†è¯¥å‚æ•°è½¬æ¢æˆä»¥â€0bâ€å‰ç¼€çš„äºŒè¿›åˆ¶å­—ç¬¦ä¸²,å¦‚æœxä¸æ˜¯ä¸€ä¸ªæ•´æ•°,é‚£ä¹ˆå°†ä¼šè°ƒç”¨å¯¹è±¡çš„__index__æ–¹æ³•çš„æ•´æ•°å¹¶è½¬æ¢æˆäºŒè¿›åˆ¶.</p><pre class="line-numbers language-none"><code class="language-none">In [15]: class a:...:     def __index__(self):...:         return 1In [14]: bin(1)Out[14]: '0b1'In [16]: bin(a())Out[16]: '0b1'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bool([x]):å¦‚æœä¸ä¼ å‚æ•°,åˆ™é»˜è®¤è¿”å›Fase,å¦‚æœXæ˜¯ä¸€ä¸ªä¸æ˜¯æ•´æ•°æˆ–æµ®ç‚¹æ•°åˆ™é¦–å…ˆè°ƒç”¨å¯¹è±¡çš„__bool__æ–¹æ³•, å¦‚æœå¯¹è±¡çš„__bool__æ–¹æ³•æœªå®šä¹‰,å…¶æ¬¡è°ƒç”¨__len__æ–¹æ³•,å¦‚æœè¿”å›0åˆ™bool()è¿”å›False,å¦åˆ™è¿”å›True,å¦‚æœå¯¹è±¡__len__ã€__bool__æ–¹æ³•éƒ½æœªå®šä¹‰åˆ™é»˜è®¤è¿”å›True</p><pre class="line-numbers language-none"><code class="language-none">In [39]: bool(1)Out[39]: TrueIn [40]: bool(0.0)Out[40]: FalseIn [41]: bool(0 - 0j)Out[41]: FalseIn [43]: class a:...:     def __bool__(self): return True...:     def __len__(self): return 0In [45]: bool(a())Out[45]: TrueIn [44]: bool(a)Out[44]: True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bytearray([source[, encoding[, errors]]]):æ¥å—ä¸€ä¸ªå¤§äºç­‰äº0å°äº256çš„æ•´æ•°æˆ–è€…ä¸€ä¸ªå¯è¿­ä»£ç±»å‹ã€å¦‚æœå‚æ•°ä¸€ä¸ªå­—ç¬¦ä¸²,é‚£ä¹ˆå¿…é¡»æŒ‡å®šencoding. è¿”å›ä¸€ä¸ªæ–°çš„å­—èŠ‚æ•°ç»„.å¦‚æœä¼ å…¥ä¸€ä¸ªå¯¹è±¡é¦–å…ˆè°ƒç”¨è¯¥å¯¹è±¡__index__, å¦‚æœæœªå®šä¹‰__index__åˆ™è°ƒç”¨å¯¹è±¡__iter__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [64]: class a:...:     def __iter__(self):...:         for i in range(0, 256):...:             yield i...:     def __index__(self): return 1...:In [65]: bytearray(a())Out[65]: bytearray(b'\x00')In [48]: bytearray()Out[48]: bytearray(b'')In [49]: bytearray([1,2,3,4,5,6,7])Out[49]: bytearray(b'\x01\x02\x03\x04\x05\x06\x07')In [77]: bytearray(1)Out[77]: bytearray(b'\x00')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>bytes([source[, encoding[, errors]]]): å¦‚åŒbytearrayä½¿ç”¨æ–¹æ³•, ä¸è¿‡è¯¥å‡½æ•°è¿”å›çš„ä¸€ä¸ªä¸å¯å˜ç±»å‹.</p><pre class="line-numbers language-none"><code class="language-none">In [72]: class a:...:     def __iter__(self):...:         for i in range(0, 256):...:             yield i...:     def __index__(self): return 1...:In [73]: bytes(a())Out[73]: b'\x00'In [79]: bytes(1)Out[79]: b'\x00'In [80]: bytes()Out[80]: b''In [81]: bytes([1,2,3,4,5,6,7])Out[81]: b'\x01\x02\x03\x04\x05\x06\x07'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>callable(object):æ¥å—ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°, å¦‚æœè¯¥å‚æ•°æ˜¯å¯ä»¥è°ƒç”¨çš„åˆ™è¿”å›True, å¦åˆ™è¿”å›False</p><pre class="line-numbers language-none"><code class="language-none">In [83]: class a:passIn [85]: callable(a)Out[85]: TrueIn [86]: callable(a())Out[86]: FalseIn [88]: class a:...:     def __call__(self):...:         return 1In [89]: callable(a())Out[89]: True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>chr(i): æ¥å—ä¸€ä¸ªæ•´æ•°, è¿”å›è¯¥æ•´æ•°å¯¹åº”çš„Unicodeä»£ç ç‚¹çš„å­—ç¬¦ä¸²,è¯¥æ•´æ•°å¿…é¡»å¤§äºç­‰äº0,å°äºç­‰äº1114112.</p><pre class="line-numbers language-none"><code class="language-none">In [105]: chr(0)Out[105]: '\x00'In [99]: chr(1114111)Out[99]: '\U0010ffff'In [100]: chr(1114112) # è¶…å‡ºèŒƒå›´---------------------------------------------------------------------------ValueError                                Traceback (most recent call last)&lt;ipython-input-100-4857faf08086&gt; in &lt;module&gt;----&gt; 1 chr(1114112)ValueError: chr() arg not in range(0x110000)==<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>@classmethod:è£…é¥°å™¨, ä½œç”¨äºç±»æ–¹æ³•ä¸Š, è¢«è£…é¥°çš„æ–¹æ³•å°†è½¬æ¢æˆç±»æ–¹æ³•,ç±»æ–¹æ³•çš„ä¸€ä¸ªå‚æ•°å°†æ˜¯ç±»æœ¬èº«.</p><pre class="line-numbers language-none"><code class="language-none">In [110]: class a:...:     def a1(self):...:         print(self)...:     @classmethod...:     def a2(self): # æŒ‰ç…§çº¦å®šåº”è¯¥å°†selfä¿®æ”¹æˆclsæ¥ä»å­—é¢é‡ä¸ŠåŒºåˆ†ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•....:         print(self)...:In [111]: a().a1() # å®ä¾‹æ–¹æ³•&lt;__main__.a object at 0x00000245CBE815C0&gt;In [112]: a.a2() # ç±»æ–¹æ³•&lt;class '__main__.a'&gt;In [113]: a().a2() # å®ä¾‹å¯ä»¥è°ƒç”¨ç±»æ–¹æ³•&lt;class '__main__.a'&gt;In [115]: a.a1() # ç±»åœ¨æœªå®ä¾‹åŒ–ä¹‹å‰ä¸èƒ½è°ƒç”¨å®ä¾‹åŒ–æ–¹æ³•, å½“ç„¶æœ‰æ·å¾„å¯ä»¥èµ°,è¿™é‡Œåªæ˜¯åšäº†ä¸€ä¸ªåŒºåˆ†, ä¸å±•ç¤ºæ·å¾„---------------------------------------------------------------------------TypeError                                 Traceback (most recent call last)&lt;ipython-input-115-2656506098d9&gt; in &lt;module&gt;----&gt; 1 a.a1()TypeError: a1() missing 1 required positional argument: 'self'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>compile(source, filename, mode, flags=0, dont_inherit=False, optimize=-1):å°†ä¸€ä¸ªå­—ç¬¦ä¸²ç¼–è¯‘æˆå­—èŠ‚ä»£ç :</p><pre class="line-numbers language-none"><code class="language-none">source: å­—ç¬¦ä¸²æˆ–è€…ASTå¯¹è±¡,filename: ä»£ç æ–‡ä»¶åç§°ï¼Œå¦‚æœä¸æ˜¯ä»æ–‡ä»¶è¯»å–ä»£ç åˆ™ä¼ é€’ä¸€äº›å¯è¾¨è®¤çš„å€¼, å¦‚â€™â€™.mode: æŒ‡å®šç¼–è¯‘ä»£ç çš„ç§ç±»ã€‚å¯ä»¥æŒ‡å®šä¸º exec, eval, singleflags: å˜é‡ä½œç”¨åŸŸï¼Œå±€éƒ¨å‘½åç©ºé—´ï¼Œå¦‚æœè¢«æä¾›ï¼Œå¯ä»¥æ˜¯ä»»ä½•æ˜ å°„å¯¹è±¡ã€‚flagså’Œdont_inheritæ˜¯ç”¨æ¥æ§åˆ¶ç¼–è¯‘æºç æ—¶çš„æ ‡å¿—In [121]: d = compile("print(1)", "", "exec")In [122]: dOut[122]: &lt;code object &lt;module&gt; at 0x00000245CBF448A0, file "", line 1&gt;In [123]: exec(d)1complex([real[, imag]]): åˆ›å»ºä¸€ä¸ªå€¼ä¸º real + imag * j çš„å¤æ•°æˆ–è€…è½¬åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–æ•°ä¸ºå¤æ•°ã€‚å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå­—ç¬¦ä¸²ï¼Œåˆ™ä¸éœ€è¦æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In [125]: complex(1, 2)<br>Out[125]: (1+2j)<br>In [127]: complex(â€œ1â€)<br>Out[127]: (1+0j)<br>In [128]: complex(â€œ1+2jâ€) # æ­¤å¤„ä¸èƒ½æœ‰ç©ºæ ¼, å¦åˆ™ä¼šæŠ¥é”™<br>Out[128]: (1+2j)<br>delattr(object, name): æ¥å—ä¸€ä¸ªå¯¹è±¡ä»¥åŠä¸€ä¸ªå­—ç¬¦ä¸²,åˆ é™¤è¯¥å¯¹è±¡çš„nameå±æ€§,ä¹Ÿå¯ä»¥ä½¿ç”¨del object.nameæ¥å®ç°.</p><pre class="line-numbers language-none"><code class="language-none">In [144]: class a:...:     x = 1...:     y = 2...:In [145]: delattr(a, "x")In [147]: a.x---------------------------------------------------------------------------AttributeError                            Traceback (most recent call last)&lt;ipython-input-147-e27186f28a17&gt; in &lt;module&gt;----&gt; 1 a.xAttributeError: type object 'a' has no attribute 'x'In [148]: a.yOut[148]: 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>dict([object]):ç”¨äºåˆ›å»ºä¸€ä¸ªå­—å…¸.å¦‚æœä¸ä¼ å‚æ•°,åˆ™è¿”å›ä¸€ä¸ªç©ºçš„å­—å…¸.</p><pre class="line-numbers language-none"><code class="language-none">In [150]: dict()Out[150]: {}In [151]: dict(a=1, b=2)Out[151]: {'a': 1, 'b': 2}In [152]: dict({"a":1})Out[152]: {'a': 1}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>dir([object]):ä¸ä¼ å‚æ•°æ—¶, è¿”å›å½“å‰èŒƒå›´å†…å˜é‡ã€æ–¹æ³•å’Œå®šä¹‰çš„ç±»å‹åˆ—è¡¨,ä¼ å…¥å‚æ•°æ—¶è¿”å›è¯¥å‚æ•°çš„æ‰€æœ‰çš„å±æ€§ã€æ–¹æ³•, å¦‚æœè¯¥å‚æ•°å®šä¹‰äº†__dir__æ–¹æ³•, åˆ™ä½¿ç”¨__dir__è¿”å›å€¼, å¦åˆ™è¯¥å‡½æ•°å°†å°½å¯èƒ½çš„æœ€å¤§é™åº¦çš„æ”¶é›†è¯¥å¯¹è±¡çš„æ–¹æ³•ä»¥åŠå±æ€§.</p><pre class="line-numbers language-none"><code class="language-none">In [157]: dir("")Out[157]:['__add__','__class__','__contains__',...]In [155]: class a:...:     def __dir__(self):...:         return ["a", "b"]...:In [156]: dir(a())Out[156]: ['a', 'b']In [158]: class a:...:     x = 1...:     y = 2...:In [159]: dir(a)[...,'x','y']<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>divmod(x, y): æ¥å—ä¸¤ä¸ªéå¤æ•°çš„æ•°å­—ä½œä¸ºå‚æ•°, è¿”å›X,Yçš„å•†å’Œä½™.</p><pre class="line-numbers language-none"><code class="language-none">In [160]: divmod(1, 2)Out[160]: (0, 1)In [161]: divmod(1.5, 2)Out[161]: (0.0, 1.5)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>enumerate(iterable, start=0):æ¥å—ä¸€ä¸ªå¯è¿­ä»£ç±»å‹ä»¥åŠä¸€ä¸ªå¯é€‰intç±»å‹çš„å‚æ•°, è¿”å›ä¸€ä¸ªæšä¸¾å¯¹è±¡.å¦‚æœæŒ‡å®šäº†startåˆ™è¯¥å¯è¿­ä»£å¯¹è±¡çš„ä¸‹è¾¹ä»startå¼€å§‹.</p><pre class="line-numbers language-none"><code class="language-none">In [163]: enumerate([1,2,3,4])Out[163]: &lt;enumerate at 0x245cbf50438&gt;In [164]: list(enumerate([1,2,3,4]))Out[164]: [(0, 1), (1, 2), (2, 3), (3, 4)]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>eval(expression, globals=None, locals=None):æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„è¡¨è¾¾å¼, å¹¶æ‰§è¡Œè¯¥è¡¨è¾¾å¼,è¿”å›å…¶å€¼.</p><pre class="line-numbers language-none"><code class="language-none">expression: å­—ç¬¦ä¸²ç±»å‹çš„è¡¨è¾¾å¼.globals: å­—å…¸ç±»å‹, å˜é‡ä½œç”¨åŸŸï¼Œå…¨å±€å‘½åç©ºé—´.locals: ä»»ä½•çš„æ˜ å°„å¯¹è±¡, å˜é‡ä½œç”¨åŸŸï¼Œå±€éƒ¨å‘½åç©ºé—´.In [166]: eval("1 + 2")Out[166]: 3exec(object[, globals[, locals]]):è¯¥å‡½æ•°æä¾›åŠ¨æ€æ‰§è¡Œpythonä»£ç çš„åŠŸèƒ½,objectå¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªä»£ç å¯¹è±¡. globalså¿…é¡»æ˜¯ä¸€ä¸ªå­—å…¸,localsåˆ™å¯ä»¥æ˜¯ä»»ä½•çš„æ˜ å°„å¯¹è±¡,In [168]: x = 1In [169]: exec("x + 2")In [172]: xOut[172]: 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>filter(function,iterable):æ¥å—ä¸€ä¸ªå‡½æ•°å¯¹è±¡ä»¥åŠä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ä½œä¸ºå‚æ•°, å°†å¯è¿­ä»£å¯¹è±¡ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°ä¸­,å¦‚æœè¯¥å‡½æ•°è¿”å›Trueåˆ™ä¿ç•™å½“å‰å…ƒç´ ,å¦åˆ™åˆ é™¤å½“å‰å…ƒç´ .filterå‡½æ•°è¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡.</p><pre class="line-numbers language-none"><code class="language-none">In [3]: list(filter(lambda x: False, [1,2,3,4]))Out[3]: []In [4]: list(filter(lambda x: True, [1,2,3,4]))Out[4]: [1, 2, 3, 4]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>float([x]): æ¥å—ä¸€ä¸ªå¯é€‰æ•´å‹ã€æµ®ç‚¹å‹ã€å¯¹è±¡æˆ–è€…å­—ç¬¦ä¸²ç±»å‹å‚æ•°, è¿”å›è¯¥å‚æ•°çš„æµ®ç‚¹ç±»å‹æ•°æ®,å¦‚æœXæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡é‚£ä¹ˆå°†è°ƒç”¨å¯¹è±¡çš„__float__æ–¹æ³•(ä»…æä¾›ç”¨æ–¹æ³•, å®Œæ•´æ–¹æ³•è§:float).</p><pre class="line-numbers language-none"><code class="language-none">In [6]: float("+1")Out[6]: 1.0In [7]: float("-1")Out[7]: -1.0In [8]: float("Inf")Out[8]: infIn [11]: float(1)Out[11]: 1.0In [12]: float(1.2)Out[12]: 1.2# è‡ªå®šä¹‰å¯¹è±¡In [14]: class a:...:     def __float__(self): return 1.0...:In [15]: float(a())Out[15]: 1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>format(value[,format_spec]):æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°, æ¥å—ä¸é™ä¸ªå‚æ•°ï¼Œä½ç½®å¯ä»¥ä¸æŒ‰é¡ºåº, å…¶æ•°å­—æ ¼å¼åŒ–ç¬¦å·è§èœé¸Ÿæ•™ç¨‹, å¯¹äºè‡ªå®šä¹‰å¯¹è±¡, åˆ™è°ƒç”¨å¯¹è±¡çš„__format__æ–¹æ³•, å¦‚æœå¯¹è±¡æ²¡æœ‰å®šä¹‰__format__åˆ™ä½¿ç”¨å¯¹è±¡__str__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [20]: "{}|{}".format(1, "dsa")Out[20]: '1|dsa'In [21]: "{1}|{0}".format(1, "dsa")Out[21]: 'dsa|1'In [22]: "{0}|{1}".format(1, "dsa")Out[22]: '1|dsa'In [23]: "{:.2f}".format(1.235646)Out[23]: '1.24'In [33]: class a:...:     def __format__(self, *args):...:         return "format"...:In [34]: "{}".format(a())Out[34]: 'format'In [36]: class a:...:     def __str__(self):...:         return "str"...:In [37]: "{}".format(a())Out[37]: 'str'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>frozenset([iterable]): æ¥å—ä¸€ä¸ªå¯é€‰çš„å¯è¿­ä»£ç±»å‹çš„å‚æ•°, è¿”å›ä¸€ä¸ªfrozensetå¯¹è±¡, è¯¥å¯¹è±¡ä¸setå¯¹è±¡åŸºæœ¬ç›¸ä¼¼, ä½†æ˜¯è¯¥å¯¹è±¡æ˜¯ä¸å¯å˜çš„.</p><pre class="line-numbers language-none"><code class="language-none">In [39]: frozenset()Out[39]: frozenset()In [40]: frozenset([1,2,1,1])Out[40]: frozenset({1, 2})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>getattr(object,name[,default]): æ¥å—ä¸¤ä¸ªå¿…é€‰å‚æ•°å’Œä¸€ä¸ªå¯é€‰å‚æ•°, è¯¥å‡½æ•°è¿”å›äº†object.nameçš„å€¼, å¦‚æœä¸å­˜åœ¨nameå±æ€§,å¹¶ä¸”æ²¡æœ‰ä¼ å…¥defaultå‚æ•°æ—¶åˆ™è§¦å‘å¼‚å¸¸, å¦‚æœä¼ å…¥äº†defaultå‚æ•°åˆ™æ²¡æœ‰æ‰¾åˆ°nameå±æ€§æ—¶è¿”å›default.</p><pre class="line-numbers language-none"><code class="language-none">In [45]: class a:...:     def b(self):...:         return "2"In [47]: getattr(a(), "b")()Out[47]: '2'getattr(a(), "b1", lambda : print("b1"))()b1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>globals(): è¿”å›å½“å‰æ‰€æœ‰å…¨å±€å˜é‡çš„å­—å…¸.</p><pre class="line-numbers language-none"><code class="language-none">In [49]: globals()Out[49]:{'__name__': '__main__','__doc__': 'Automatically created module for IPython interactive environment','__package__': None,...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>hasattr(object, name): æ¥å—ä¸¤ä¸ªå¿…é€‰å‚æ•°, æ£€æµ‹objectä¸­æ˜¯å¦æœ‰é‚£ä¹ˆå±æ€§.å¦‚æœæœ‰nameå±æ€§è¿”å›True,å¦åˆ™è¿”å›False.</p><pre class="line-numbers language-none"><code class="language-none">In [50]: class a:...:     b = 1...:In [51]: hasattr(a, "b")Out[51]: TrueIn [52]: hasattr(a, "b1")Out[52]: False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>hash(object): æ¥å—ä¸€ä¸ªå¿…é€‰å‚æ•°, è¿”å›è¯¥å¯¹è±¡çš„æ•´å‹å“ˆå¸Œå€¼, å¦‚æœæ—¶è‡ªå®šä¹‰å¯¹è±¡åˆ™è°ƒç”¨å¯¹è±¡çš„__hash__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [56]: hash("fdsaf")Out[56]: 2111967917974353823In [58]: class a:...:     def __hash__(self):...:         return 9527...:In [59]: hash(a())Out[59]: 9527<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>help([object]): æ¥å—ä¸€ä¸ªå¯é€‰çš„å‚æ•°, è¯¥å‚æ•°å¯ä»¥æ˜¯ä»»æ„çš„ç±»å‹, è¿”å›è¯¥å¯¹è±¡çš„å¸®åŠ©æ–‡æ¡£, å¦‚æœæ˜¯è‡ªå®šä¹‰å¯¹è±¡, åˆ™è¿”å›è¯¥å‡½æ•°æˆ–è€…ç±»çš„æ³¨é‡Š.å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°åˆ™æ‹‰èµ·äº¤äº’å¼çš„å¸®åŠ©ç³»ç»Ÿ</p><pre class="line-numbers language-none"><code class="language-none">In [62]: help(1)Help on int object:class int(object)|  int(x=0) -&gt; integer...In [65]: class a:...:     """è¿™æ˜¯helpä¿¡æ¯"""...:     def b(self):...:         """è¿™ä¹Ÿæ˜¯helpä¿¡æ¯"""...:         passIn [66]: help(a())Help on a in module __main__ object:class a(builtins.object)|  è¿™æ˜¯helpä¿¡æ¯||  Methods defined here:||  b(self)|      è¿™ä¹Ÿæ˜¯helpä¿¡æ¯||  ----------------------------------------------------------------------|  Data descriptors defined here:||  __dict__|      dictionary for instance variables (if defined)||  __weakref__|      list of weak references to the object (if defined)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>hex(x):æ¥å—ä¸€ä¸ªæ•´å‹ä½œä¸ºå¿…é€‰å‚æ•°, è¿”å›è¯¥å‚æ•°çš„16è¿›åˆ¶å­—ç¬¦ä¸², è¯¥å­—ç¬¦ä¸²ä»¥0xå¼€å¤´,å¦‚æœxæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡é‚£ä¹ˆè¯¥å¯¹è±¡å¿…é¡»å®ç°__index__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [72]: hex(185)Out[72]: '0xb9'In [74]: class a:...:     def __index__(self): return 1In [75]: hex(a())Out[75]: '0x1'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>id(object): è¿”å›è¯¥å¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€ä»¥æ•´å‹è¿”å›.</p><pre class="line-numbers language-none"><code class="language-none">In [77]: id(1)Out[77]: 1786755536In [81]: class a:...:     def __init__(self, x):...:         self.x = x...:In [82]: id(a(1)) == id(2)Out[82]: False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>input([prompt]): ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–è¾“å…¥ä¸€å›è½¦é”®ç»“æŸ, å¦‚æœä¼ å…¥prompt, åˆ™å°†promptæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºä¸­.</p><pre class="line-numbers language-none"><code class="language-none">In [84]: input("è¿™æ˜¯æç¤º:")è¿™æ˜¯æç¤º:ddOut[84]: 'dd'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>int(x, base=10):å°†ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–æ•°å­—è½¬æ¢ä¸ºæ•´å‹,å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°åˆ™è¿”å›0,å¦‚æœä¼ å…¥ä¼ å…¥äº†baseåˆ™è¡¨ç¤ºXæ˜¯baseè¿›åˆ¶çš„æ•°å­—.å¦‚æœXæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡, åˆ™è°ƒç”¨__init__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [86]: int()Out[86]: 0In [87]: int(1.0)Out[87]: 1In [90]: int("0x9b", 16)Out[90]: 155In [91]: class a:...:     def __int__(self):...:         return 1In [92]: int(a())Out[92]: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>isinstance(object, classinfo):å¦‚æœobjectæ˜¯classinfoçš„å®ä¾‹æˆ–è€…å­ç±»çš„å®ä¾‹, è¿”å›True, å¦åˆ™è¿”å›False.å¦‚æœclassinfoæ˜¯ä¸€ä¸ªå…ƒç»„, é‚£ä¹ˆobjectåªè¦æ˜¯å…ƒç»„ä¸­ä»»æ„ä¸€ä¸ªå…ƒç´ çš„å­ç±»çš„å®ä¾‹æˆ–è€…å®ä¾‹åŒ–éƒ½è¿”å›True.</p><pre class="line-numbers language-none"><code class="language-none">In [94]: class a: passIn [95]: class b(a): passIn [99]: isinstance(b(), a)Out[99]: TrueIn [101]: isinstance(1, int)Out[101]: TrueIn [103]: isinstance(1, str)Out[103]: False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>issubclass(class, classinfo):å¦‚æœclassæ˜¯classinfoçš„å­ç±»è¿”å›true, ä½¿ç”¨æ–¹æ³•ä¸isinstanceç›¸åŒ.</p><pre class="line-numbers language-none"><code class="language-none">In [94]: class a: passIn [95]: class b(a): passIn [105]: issubclass(b, a)Out[105]: True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>iter(object[,sentinel]):è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡, å¦‚æœæ²¡æœ‰ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°, é‚£ä¹ˆobjectå¿…é¡»æ˜¯å®ç°äº†è¿­ä»£åè®®æˆ–è€…åºåˆ—åè®®å¦åˆ™å°†è§¦å‘TypeError, å¦‚æœä¼ å…¥äº†sentinelå‚æ•°é‚£ä¹ˆobjectå¿…é¡»æ˜¯å¯è°ƒç”¨å¯¹è±¡, æ­¤æ—¶æ¯è¿­ä»£ä¸€æ¬¡éƒ½è°ƒç”¨object,å¦‚æœobjectè¿”å›çš„å€¼ç­‰äºsentinelæ—¶,è§¦å‘StopIterationå¼‚å¸¸.</p><pre class="line-numbers language-none"><code class="language-none">In [108]: iter([1,2,3])Out[108]: &lt;list_iterator at 0x210bde35f98&gt;In [110]: class a:...:     def __iter__(self):...:         for i in range(10):...:             yield i...:In [111]: list(iter(a()))Out[111]: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]In [12]: def a():...:     global num...:     num += 1...:     if num &gt;= 10:...:         return -1...:     return numIn [13]: for i in iter(a, -1):...:     print(i)123456789<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>len(s): æ¥å—ä¸€ä¸ªåºåˆ—æˆ–è€…é›†åˆç±»å‹å¯¹è±¡, è¿”å›å…¶é•¿åº¦, å¦‚æœæ—¶è‡ªå®šä¹‰å¯¹è±¡, å°†ä¼šè°ƒç”¨å¯¹è±¡çš„__len__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [18]: len([1,2,3])Out[18]: 3In [19]: len({1:2, 3:4})Out[19]: 2In [20]: class a:...:     def __len__(self): return 1In [21]: len(a())Out[21]: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>locals():è¿”å›å½“å‰æœ¬åœ°å’Œåªæœ‰å˜é‡çš„å€¼.</p><pre class="line-numbers language-none"><code class="language-none">In [24]: def a():...:     x = 1...:     print(locals())In [25]: a(){'x': 1}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>map(function,iterableâ€¦):è¿”å›ä¸€ä¸ªè¿­ä»£å™¨, è¯¥å‡½æ•°å°†functionåº”ç”¨ä¸æ¯ä¸€ä¸ªiterableå…ƒç´ ä¸Šå¹¶è¿”å›ç›´åˆ°å¯è¿­ä»£å¯¹è±¡è€—å°½.</p><pre class="line-numbers language-none"><code class="language-none">In [27]: map(lambda x: x ** 2, [1,2,3])Out[27]: &lt;map at 0x2aec3ae4a20&gt;In [28]: list(map(lambda x: x ** 2, [1,2,3]))Out[28]: [1, 4, 9]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>max(arg1,arg2,*args[,key]):æ¥å—å¤šä¸ªä½ç½®å‚æ•°æˆ–è€…ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡, è¿”å›å…¶ä¸­æœ€å¤§çš„å€¼.</p><pre class="line-numbers language-none"><code class="language-none">In [39]: max(1,2)Out[39]: 2In [40]: max([2,3,4,5])Out[40]: 5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>memoryview(obj): è¿”å›objçš„å†…å­˜æŸ¥çœ‹å¯¹è±¡(å¯¹æ”¯æŒç¼“å†²åŒºåè®®çš„æ•°æ®è¿›è¡ŒåŒ…è£…ï¼Œåœ¨ä¸éœ€è¦å¤åˆ¶å¯¹è±¡åŸºç¡€ä¸Šå…è®¸Pythonä»£ç è®¿é—®).</p><pre class="line-numbers language-none"><code class="language-none">In [43]: a = b"dsadsad"In [44]: d = memoryview(a)In [47]: d[0]Out[47]: 10# æœªå¤åˆ¶æ•°æ®In [52]: id(d.obj)Out[52]: 2949631565952In [53]: id(a)Out[53]: 2949631565952<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>min(arg1ï¼Œarg2ï¼Œ* args[ï¼Œkey]): æ¥å—å¤šä¸ªä½ç½®å‚æ•°æˆ–è€…ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡, è¿”å›å…¶ä¸­æœ€å°çš„å€¼.</p><pre class="line-numbers language-none"><code class="language-none">In [55]: min(1,2)Out[55]: 1In [56]: min([1,2,3,5])Out[56]: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>next(iterator[,default]): é€šè¿‡è°ƒç”¨iteratorçš„__next__æ–¹æ³•å¹¶è¿”å›å…¶å€¼.</p><pre class="line-numbers language-none"><code class="language-none">In [58]: class a:...:     def __next__(self):...:         for i in range(10):...:             yield iIn [60]: list(next(a()))Out[60]: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>object(): è¿”å›ä¸€ä¸ªæ–°çš„æ— ä»»ä½•ç‰¹å¾çš„å¯¹è±¡, objectæ—¶æ‰€æœ‰classçš„åŸºç±».</p><pre class="line-numbers language-none"><code class="language-none">In [105]: object()Out[105]: &lt;object at 0x2aec3a34880&gt;In [106]: class a:passIn [107]: issubclass(a, object)Out[107]: True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>oct(x):æ¥å—ä¸€ä¸ªæ•´å‹ä½œä¸ºå‚æ•°è¿”å›ä»¥â€0oâ€ä¸ºå‰ç¼€çš„å…«è¿›åˆ¶å­—ç¬¦ä¸²,å¦‚æœxæ˜¯è‡ªå®šä¹‰å¯¹è±¡, åˆ™è°ƒç”¨è¯¥å¯¹è±¡çš„__index__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [109]: oct(1)Out[109]: '0o1'In [111]: class a:...:     def __index__(self): return 1In [112]: oct(a())Out[112]: '0o1'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>open(file,mode=â€™râ€™,buffering=-1,encoding=None,errors=None,newline=None,<br>closefd=True,opener=None):æ‰“å¼€fileæ–‡ä»¶å¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡, å…·ä½“å‚æ•°å€¼è§open.</p><pre class="line-numbers language-none"><code class="language-none">file: æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ä»¥åŠæ–‡ä»¶åmode: æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼, é»˜è®¤"râ€buffering: ç”¨äºè®¾ç½®ç¼“å†²ç­–ç•¥, 0ä¸ºå…³é—­ç¼“å†², 1ä¸ºé€‰æ‹©è¡Œç¼“å†², &gt; 1ä»¥æŒ‡ç¤ºå›ºå®šå¤§å°çš„å—ç¼“å­˜åŒº.é»˜è®¤-1,äºŒè¿›åˆ¶æ–‡ä»¶ä»¥å›ºå®šå¤§å°çš„å—ç¼“å†² 4.encoding:ç”¨äºè§£ç æˆ–ç¼–ç æ–‡ä»¶çš„ç¼–ç çš„åç§°, é»˜è®¤ç¼–ç å–å†³äºæ‰€åœ¨çš„æ“ä½œç³»ç»Ÿ 5.errors:æŒ‡å®šå¦‚ä½•å¤„ç†ç¼–ç å’Œè§£ç é”™è¯¯, ä»…èƒ½åœ¨æ–‡æœ¬æ¨¡å¼ä¸‹ä½¿ç”¨ 6.newline: æ§åˆ¶é€šç”¨æ¢è¡Œæ¨¡å¼çš„å·¥ä½œæ–¹å¼ï¼ˆä»…é€‚ç”¨äºæ–‡æœ¬æ¨¡å¼ï¼‰ã€‚å®ƒå¯ä»¥æ˜¯Noneï¼Œ''ï¼Œ'\nâ€™ï¼Œ'\râ€™ï¼Œå’Œâ€™\r\nâ€™In [114]: open("test.test", "w").write("fdsa")Out[114]: 4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ord(c): æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹å‚æ•°, è¿”å›è¯¥Unicodeä»£ç ç‚¹çš„æ•´æ•°.</p><pre class="line-numbers language-none"><code class="language-none">In [116]: ord("a")Out[116]: 97In [117]: ord("ä½ ")Out[117]: 20320<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>pow(x,y[,z]):å½“æœªä¼ å…¥Zå‚æ•°æ—¶,è¿”å›xçš„yæ¬¡æ–¹,å¦‚æœä¼ å…¥äº†Zåˆ™å¯¹ç»“æœå–ä½™.</p><pre class="line-numbers language-none"><code class="language-none">In [122]: pow(2,3)Out[122]: 8In [124]: pow(2,3, 2)Out[124]: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>print(*objects,sep=â€™ â€˜,end=â€™\nâ€™,file=sys.stdout,flush=False):å°†objectså¯¹è±¡æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºä¸­,æ¯ä¸€ä¸ªobjectsä½¿ç”¨sepåˆ†å‰², ä»¥endç»“æŸ,å¯¹äºè‡ªå®šä¹‰å¯¹è±¡, é¦–å…ˆè°ƒç”¨å¯¹è±¡__str__æ–¹æ³•, å¦‚æœæ²¡æœ‰å®šä¹‰__str__æ–¹æ³•åˆ™è°ƒç”¨__repr__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [136]: class a:...:     def __str__(self): return "str"...:     def __repr__(self): return "repr"In [137]: print(a())str<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>property(fget=Noneï¼Œfset=Noneï¼Œfdel=Noneï¼Œdoc=None): å¯ä½œä¸ºè£…é¥°å™¨ä½¿ç”¨ä¹Ÿå¯ä½œä¸ºå‡½æ•°ä½¿ç”¨.ç”¨äºæ˜¾ç¤ºç±»å±æ€§çš„è¯»å–ã€è®¾ç½®ä»¥åŠåˆ é™¤. ä½œä¸ºå‡½æ•°ä½¿ç”¨æ—¶:</p><pre class="line-numbers language-none"><code class="language-none">In [140]: class a:...:     def __init__(self):...:         self._x = None...:...:     def getx(self):...:         return self._x...:...:     def setx(self, x):...:         self._x = x...:     def delx(self):...:         self._x = None...:     x = property(getx, setx, delx, "test")<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½œä¸ºè£…é¥°å™¨ä½¿ç”¨æ—¶:</p><pre class="line-numbers language-none"><code class="language-none">class a:def __init__(self):self._x = None@propertydef x(self):return self._x@x.fsetdef x(self, x):self._x = x@x.fdeldef x(self):self._x = Noneå‚æ•°:fget â€“ è·å–å±æ€§å€¼çš„å‡½æ•°fset â€“ è®¾ç½®å±æ€§å€¼çš„å‡½æ•°fdel â€“ åˆ é™¤å±æ€§å€¼å‡½æ•°doc â€“ å±æ€§æè¿°ä¿¡æ¯<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>range(start,stop[,step]):rangeå¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°, rangeæ—¶ä¸€ä¸ªä¸å¯å˜åºåˆ—ç±»å‹,è¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡.</p><pre class="line-numbers language-none"><code class="language-none">In [149]: list(range(1, 10, 2))Out[149]: [1, 3, 5, 7, 9]In [150]: list(range(1, 10))Out[150]: [1, 2, 3, 4, 5, 6, 7, 8, 9]In [151]: list(range(10))Out[151]: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]In [152]: type(range) # éå‡½æ•°Out[152]: type<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>repr(object): è¿”å›å¯æ‰“å°çš„å­—ç¬¦ä¸²,æ­¤å‡½æ•°å°è¯•è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²åœ¨ä¼ é€’æ—¶ä¼šäº§ç”Ÿå…·æœ‰ç›¸åŒå€¼çš„å¯¹è±¡eval()ï¼Œå¦åˆ™è¡¨ç¤ºå½¢å¼æ˜¯ä¸€ä¸ªæ‹¬åœ¨å°–æ‹¬å·ä¸­çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«å¯¹è±¡ç±»å‹çš„åç§°ä»¥åŠå…¶ä»–ä¿¡æ¯é€šå¸¸åŒ…æ‹¬å¯¹è±¡çš„åç§°å’Œåœ°å€ã€‚ç±»å¯ä»¥é€šè¿‡å®šä¹‰__repr__()æ–¹æ³•æ¥æ§åˆ¶æ­¤å‡½æ•°ä¸ºå…¶å®ä¾‹è¿”å›çš„å†…å®¹.</p><pre class="line-numbers language-none"><code class="language-none">In [154]: repr(1)Out[154]: '1'In [155]: class a:...:     def __repr__(self): return "1"In [156]: repr(a())Out[156]: '1'In [157]: repr(a)Out[157]: "&lt;class '__main__.a'&gt;"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>reversed(seq):æ¥å—ä¸€ä¸ªå¯è¿­ä»£ç±»å‹, è¿”å›è¯¥å¯è¿­ä»£ç±»å‹çš„åå‘è¿­ä»£å™¨.</p><pre class="line-numbers language-none"><code class="language-none">In [161]: list(reversed(range(10)))Out[161]: [9, 8, 7, 6, 5, 4, 3, 2, 1, 0]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>round(num, [, ndigits]): è¿”å›numå››èˆäº”å…¥ç²¾ç¡®åˆ°ndigitsç²¾åº¦æ•°å­—, å¦‚æœæ²¡æœ‰ä¼ å…¥ndigitsåˆ™è¿”å›æœ€æ¥è¿‘numçš„æ•´æ•°, å¦‚æœnumæ—¶ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡, åˆ™è°ƒç”¨__round__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [163]: round(1.2563, 2)Out[163]: 1.26In [164]: round(1.2563)Out[164]: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>set([iterable]):è¿”å›ä¸€ä¸ªæ–°çš„setç±»å‹å¯¹è±¡, æ¥å—å¯é€‰å¯è¿­ä»£ç±»å‹å‚æ•°, å¹¶å°†å¯è¿­ä»£ç±»å‹å‚æ•°è½¬æ¢æˆsetç±»å‹è¿”å›.</p><pre class="line-numbers language-none"><code class="language-none">In [166]: set()Out[166]: set()In [167]: set([1,2,3])Out[167]: {1, 2, 3}In [168]: set(range(10))Out[168]: {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>setattr(object, name, value): æ¥å—ä¸‰ä¸ªå¿…é€‰å‚æ•°, å°†object.nameå±æ€§èµ‹å€¼ä¸ºvalue.</p><pre class="line-numbers language-none"><code class="language-none">In [172]: class a: passIn [173]: a1 = a()In [174]: setattr(a1, "b", 1)In [175]: a1.bOut[175]: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>slice(start,stop[,step]):è¿”å›è¡¨ç¤ºç”±æŒ‡å®šçš„ç´¢å¼•é›†çš„åˆ‡ç‰‡å¯¹è±¡, è¯¥å¯¹è±¡ä¸ºåªè¯»æ•°æ®å±æ€§.</p><pre class="line-numbers language-none"><code class="language-none">In [178]: slice(0, 1)Out[178]: slice(0, 1, None)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>sorted(iterable,*,key=None,reverse=False):å°†_iterable_å¯¹è±¡æ’åºåè¿”å›.</p><pre class="line-numbers language-none"><code class="language-none">key: å¯é€‰å…³é”®å­—å‚æ•°,_key_æŒ‡å®šä¸€ä¸ªå‚æ•°çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºä»_iterableä¸­çš„_æ¯ä¸ªå…ƒç´ ä¸­æå–æ¯”è¾ƒé”®reverse: å¯é€‰å…³é”®å­—å‚æ•°, å¦‚æœè®¾ç½®ä¸ºTrueï¼Œåˆ™åˆ—è¡¨å…ƒç´ å°†æŒ‰ç…§æ¯ä¸ªæ¯”è¾ƒç›¸åçš„æ–¹å¼è¿›è¡Œæ’åº.In [181]: sorted(["12", "1", "34", "6", "90"], key=int)Out[181]: ['1', '6', '12', '34', '90']In [182]: sorted(["12", "1", "34", "6", "90"], key=int, reverse=True)Out[182]: ['90', '34', '12', '6', '1']<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>@staticmethod: è£…é¥°å™¨å‡½æ•°, ä½œç”¨äºç±»æ–¹æ³•ä¸Š, å°†æ–¹æ³•è½¬æ¢æˆé™æ€æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [185]: class a:...:     @staticmethod...:     def b(x):...:         return xIn [186]: a.b(1)Out[186]: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>str(object=bâ€™â€™,encoding=â€™utf-8â€™,errors=â€™strictâ€™):è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å¯¹è±¡,å¦‚æœobjectæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡, é‚£ä¹ˆé¦–å…ˆä¼šè°ƒç”¨å¯¹è±¡çš„__str__æ–¹æ³•, å¦‚æœæ²¡æœ‰å®ç°__str__æ–¹æ³•åˆ™è°ƒç”¨__repr__æ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [194]: class a:...:     def __repr__(self): return "re"...:     def __str__(self): return "str"In [195]: str(a())Out[195]: 'str'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>sum(iterable[,start]):å¦‚æœæ²¡æœ‰ä¼ å…¥_start_å‚æ•°, åˆ™å°†_iterable_æ‰€æœ‰çš„å…ƒç´ å åŠ åè¿”å›, å¦‚æœä¼ å…¥äº†_start_å‚æ•°,åˆ™ä»_start_å‚æ•°å¼€å§‹å°†_iterable_çš„å…ƒç´ ä»å·¦è‡³å³çš„å åŠ .</p><pre class="line-numbers language-none"><code class="language-none">In [201]: sum([1,2,3], 8)Out[201]: 14In [207]: sum(range(1, 101))Out[207]: 5050<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>super([type[,object-or-type]]):è¯¥å‡½æ•°ç”¨äºè°ƒç”¨çˆ¶ç±»(è¶…ç±»)çš„ä¸€ä¸ªæ–¹æ³•.</p><pre class="line-numbers language-none"><code class="language-none">In [209]: class a:...:     def add(self, x):...:         return x + 1In [210]: class b(a):...:     def add(self, x):...:         return super().add(x)In [211]: b().add(1)Out[212]: 2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>tuple([iterable]):è¿”å›ä¸€ä¸ªå…ƒç»„å¯¹è±¡, æ¥å—ä¸€ä¸ªå¯é€‰çš„å¯è¿­ä»£å‚æ•°, å¦‚æœä¼ å…¥äº†è¯¥å‚æ•°åˆ™å°†è¯¥å‚æ•°è½¬æ¢æˆå…ƒç»„å¯¹è±¡.</p><pre class="line-numbers language-none"><code class="language-none">In [214]: tuple([1,2,3,4])Out[214]: (1, 2, 3, 4)In [215]: tuple()Out[215]: ()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>type(name,bases,dict):åªä¼ å…¥ä¸€ä¸ªå‚æ•°æ—¶å°†è¿”å›è¯¥å‚æ•°çš„ç±»å‹,ä½¿ç”¨ä¸‰ä¸ªå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæ–°ç±»å‹å¯¹è±¡,nameåˆ™æˆä¸ºç±»å¯¹è±¡çš„åç§°,baseåˆ™è¡¨æ˜äº†å…¶çˆ¶ç±», å¯é€‰çš„å…³é”®å­—å‚æ•°åˆ™å°†æˆä¸ºç±»çš„å±æ€§.(typeæ˜¯ç±»å‹å®ä¾‹å…³ç³»çš„é¡¶ç«¯, objectæ˜¯çˆ¶å­å…³ç³»çš„é¡¶ç«¯ï¼Œæ‰€æœ‰çš„æ•°æ®ç±»å‹çš„çˆ¶ç±»éƒ½æ˜¯å®ƒ, Objectæ˜¯typeçš„ä¸€ä¸ªå®ä¾‹,Typeæ˜¯objectçš„å­ç±», è¯¦ç»†è§typeå’Œobjectä¹‹é—´çš„å…³ç³»)</p><pre class="line-numbers language-none"><code class="language-none">In [222]: d = type("objects", (), {"names": "this is name"})In [223]: dOut[223]: __main__.objectsIn [224]: d.namesOut[224]: 'this is name'In [217]: type(1)Out[217]: int<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>vars([object]):è¿”å›æ¨¡å—ã€ç±»ã€å®ä¾‹ã€å…¶ä»–å¯¹è±¡çš„__dict__å±æ€§.</p><pre class="line-numbers language-none"><code class="language-none">In [232]: class a:...:     x = 1In [233]: vars(a)Out[233]:mappingproxy({'__module__': '__main__','x': 1,'__dict__': &lt;attribute '__dict__' of 'a' objects&gt;,'__weakref__': &lt;attribute '__weakref__' of 'a' objects&gt;,'__doc__': None})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>zip(*iterables):å°†å¯è¿­ä»£çš„å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå°†å¯¹è±¡ä¸­å¯¹åº”çš„å…ƒç´ æ‰“åŒ…æˆä¸€ä¸ªä¸ªå…ƒç»„ï¼Œç„¶åè¿”å›ç”±è¿™äº›å…ƒç»„ç»„æˆçš„åˆ—è¡¨,å¦‚æœå„ä¸ªè¿­ä»£å™¨çš„å…ƒç´ ä¸ªæ•°ä¸ä¸€è‡´ï¼Œåˆ™è¿”å›åˆ—è¡¨é•¿åº¦ä¸æœ€çŸ­çš„å¯¹è±¡ç›¸åŒ.</p><pre class="line-numbers language-none"><code class="language-none">In [237]: zip([1,2,3,4], ["q", "w", "e", "r"])Out[237]: &lt;zip at 0x2aec3ad6d88&gt;In [238]: list(zip([1,2,3,4], ["q", "w", "e", "r"]))Out[238]: [(1, 'q'), (2, 'w'), (3, 'e'), (4, 'r')]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>import(name,globals=None,locals=None,fromlist=(),level=0):import è¯­å¥å°†ä¼šè°ƒç”¨è¯¥å‡½æ•°,è¯¥å‡½æ•°å¯¼å…¥æ¨¡å—_name_, ä½¿ç”¨ç»™å®šçš„_globalså’Œ_localsæ¥ç¡®å®šå¦‚ä½•è§£é‡ŠåŒ…ä¸Šä¸‹æ–‡ä¸­çš„åç§°.</p><pre class="line-numbers language-none"><code class="language-none">In [240]: __import__("requests")Out[240]: &lt;module 'requests' from 'd:\\anaconda3\\envs\\python3\\lib\\site-packages\\requests\\__init__.py'&gt;In [241]: requests = __import__("requests")In [242]: requests.__version__Out[242]: '2.21.0'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> æŠ€æœ¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>aiohttp,asyncio,RunTimeError</title>
      <link href="//post/aiohttp-asyncio-runtimeerror.html"/>
      <url>//post/aiohttp-asyncio-runtimeerror.html</url>
      
        <content type="html"><![CDATA[<p>Firstly, you may have encountered the AssertionError: There is no current event loop in thread â€˜Thread-1â€™. This is because each thread in an asyncio program has its own event loop, but only the main thread will automatically create an event loop. Therefore, if you call asyncio.get_event_loop() in a sub-thread, you will encounter this error.</p><p>To solve this problem, you need to explicitly create and set an event loop when starting the thread. Sample code is as follows:</p><pre class="line-numbers language-none"><code class="language-none">loop = asyncio.new_event_loop()asyncio.set_event_loop(loop)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>Once you do this, you should be able to use get_event_loop() to work properly in a specific thread.</p>]]></content>
      
      
      
        <tags>
            
            <tag> bug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµç•…çš„python--dictçš„ä¼˜ç‚¹ä»¥åŠç¼ºç‚¹</title>
      <link href="//post/liu-chang-de-python-dict-de-you-dian-yi-ji-que-dian.html"/>
      <url>//post/liu-chang-de-python-dict-de-you-dian-yi-ji-que-dian.html</url>
      
        <content type="html"><![CDATA[<p>ä»¥ä¸‹æ˜¯Pythonä¸­å­—å…¸çš„ä¸€äº›ç‰¹ç‚¹ï¼š</p><ol><li>å¥å¿…é¡»æ˜¯å¯æ•£åˆ—çš„ã€‚è¿™æ„å‘³ç€é”®å¿…é¡»æ”¯æŒhash()å‡½æ•°ï¼Œå¹¶ä¸”é€šè¿‡hash()æ–¹æ³•å¾—åˆ°çš„æ•£åˆ—å€¼æ˜¯ä¸å˜çš„ã€‚æ­¤å¤–ï¼Œå®ƒä»¬è¿˜å¿…é¡»æ”¯æŒeq()æ–¹æ³•ä»¥æ£€æµ‹ç›¸ç­‰æ€§ã€‚å¦‚æœa == bï¼Œåˆ™hash(a) == hash(b)ã€‚</li><li>å­—å…¸å†…å­˜å¼€é”€å¤§ã€‚ç”±äºå­—å…¸æ˜¯ç”±æ•£åˆ—è¡¨å®ç°çš„ï¼Œæ•£åˆ—è¡¨ä¸­å¯èƒ½ä¼šæœ‰ä¸€äº›ç¨€ç–æ€§ï¼Œè¿™ä¼šå ç”¨ä¸€äº›ç©ºé—´ã€‚ä¸å­—å…¸çš„é€Ÿåº¦ç›¸æ¯”ï¼Œè¿™äº›å†…å­˜æ¶ˆè€—å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li><li>å­—å…¸çš„é”®é¡ºåºä¸æ˜¯å”¯ä¸€çš„ã€‚ç”±äºæ•£åˆ—è¡¨åœ¨æ’å…¥æˆ–è¯»å–æ—¶å¯èƒ½ä¼šäº§ç”Ÿæ•£åˆ—å†²çªï¼Œå› æ­¤å­—å…¸ä¸­é”®çš„é¡ºåºä¸æ˜¯å”¯ä¸€çš„ã€‚ä½†æ˜¯ï¼Œä¸ç®¡å­—å…¸é”®çš„é¡ºåºå¦‚ä½•å˜åŒ–ï¼Œå¦‚æœä¸¤ä¸ªå­—å…¸é”®å€¼å¯¹éƒ½ç›¸åŒï¼Œåˆ™è¿™ä¸¤ä¸ªå­—å…¸æ˜¯ç›¸ç­‰çš„ã€‚</li></ol><pre class="line-numbers language-none"><code class="language-none">a = {    "1": 1,    "2": 3,    "3": 4,    "4": 4}b = {    "3": 3,    "4": 4,    "1": 1,    "2": 2}a == bTrue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hash tables in Python dictionaries</title>
      <link href="//post/liu-chang-de-python-zi-dian-zhong-de-san-lie-biao.html"/>
      <url>//post/liu-chang-de-python-zi-dian-zhong-de-san-lie-biao.html</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>Dictionaries in Python use hash tables, which are actually sparse arrays, meaning that some elements are empty. When constructing a dictionary, two table elements are used, one to mark the keys and the other to mark the values. Because the lengths of the two table elements are equal, the dictionary can be searched by the offset of the table elements.</p><p>In Python, the most efficient built-in data types are dictionaries and sets, both of which are implemented through hash tables. To test the speed of different data types in Python, I conducted the following experiment:</p><pre class="line-numbers language-none"><code class="language-none">import timeMAX = 10000000list_a = [i for i in range(MAX)]set_a = set(list_a)dict_a = {}.fromkeys(list_a)test = [i for i in range(1000)]def testTime(x,name):    start = time.clock()    for i in test:        if i in x:            pass    print(name,':','%f' % (time.clock() - start))testTime(list_a, 'list')testTime(set_a, 'set')testTime(dict_a, 'dict')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>The results are as follows:</p><pre class="line-numbers language-none"><code class="language-none">list : 0.012472set : 0.000079dict : 0.000071<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>From the above, it can be seen that sets and dictionaries are much faster than other types. This is because lists do not support the <code>in</code> operator with hash tables.</p><p>The hash algorithm works as follows: for example, if Python wants to obtain the value behind <code>dict[key]</code>, it first uses <code>hash(key)</code> to calculate the hash value of the key, and then takes the lowest few digits of the hash value as the offset of the table element. If the table element is empty, a <code>KeyError</code> exception will be thrown; if found, a <code>key:value</code> value will be obtained, and Python will compare the hash values of the two keys. If they are identical, the value is returned, and if they are not equal, it is called a hash collision. This occurs because the hash table maps random elements to a few digits, and the hash table needs to rely on this number for retrieval. To solve this problem, the hash table will take a few more digits and search the table elements. If the table element is empty, a <code>KeyError</code> exception will be thrown; if not found, the above steps will be repeated until found.</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµç•…çš„python--ç‰¹æ®Šæ–¹æ³•</title>
      <link href="//post/liu-chang-de-python-te-shu-fang-fa.html"/>
      <url>//post/liu-chang-de-python-te-shu-fang-fa.html</url>
      
        <content type="html"><![CDATA[<p>Pythonä¸­çš„ç‰¹æ®Šæ–¹æ³•ä¸»è¦æ˜¯è¢«Pythonè§£é‡Šå™¨è°ƒç”¨ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸éœ€è¦è‡ªå·±å®ç°ç‰¹æ®Šæ–¹æ³•ï¼Œæ¯”å¦‚<code>len(x)</code>ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>len()</code>æ–¹æ³•ã€‚åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šä½¿ç”¨<code>x.len()</code>è¿™æ ·çš„å†™æ³•ã€‚å¦‚æœ<code>x</code>æ˜¯ä¸€ä¸ªè‡ªå·±å®ç°çš„ç±»å¹¶ä¸”åœ¨ç±»é‡Œé¢å®ç°äº†ä¸€ä¸ª<code>len()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆPythonå°±ä¼šè°ƒç”¨è¿™ä¸ªç±»é‡Œé¢çš„æ–¹æ³•ã€‚</p><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè°ƒç”¨ç‰¹æ®Šæ–¹æ³•éƒ½æ˜¯éšå¼è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š<code>for i in x:</code>ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†<code>x</code>çš„<code>iter()</code>æ–¹æ³•ã€‚æ‰€æœ‰çš„ç‰¹æ®Šæ–¹æ³•éƒ½å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†åœ¨ç¼–ç¨‹æ—¶ä¸å»ºè®®å¤§é‡å®ç°ç‰¹æ®Šæ–¹æ³•ï¼Œé™¤éè¿›è¡Œå…ƒç¼–ç¨‹ã€‚</p><p>å› æ­¤ï¼Œåœ¨è‡ªå®šä¹‰ç±»æ—¶åº”è¯¥éµå¾ªPythonçš„æƒ¯ä¾‹ï¼Œå°½å¯èƒ½ä½¿ç”¨Pythonå†…ç½®çš„æ–¹æ³•å’Œå‡½æ•°ï¼Œè€Œä¸æ˜¯è¿‡åº¦å®ç°ç‰¹æ®Šæ–¹æ³•ã€‚è¿™æ ·å¯ä»¥æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚åŒæ—¶ï¼Œåˆç†åœ°å®ç°ç‰¹æ®Šæ–¹æ³•ä¹Ÿæ˜¯å…ƒç¼–ç¨‹çš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å®ç°æ›´é«˜çº§çš„åŠŸèƒ½ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonæ ¹æ®exifä¿¡æ¯æ—‹è½¬å›¾ç‰‡</title>
      <link href="//post/python-gen-ju-exif-xin-xi-xuan-zhuan-tu-pian.html"/>
      <url>//post/python-gen-ju-exif-xin-xi-xuan-zhuan-tu-pian.html</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘å†™ä¸šåŠ¡ä»£ç æ—¶é‡åˆ°äº†ä¸€ä¸ªéœ€æ±‚ï¼šå‹ç¼©å›¾ç‰‡ã€‚è¿™æœ¬åº”è¯¥æ˜¯ä¸€ä¸ªç®€å•çš„éœ€æ±‚ï¼Œä¸‰ä¸‹äº”é™¤äºŒå°±èƒ½è§£å†³ã€‚ä½†æ˜¯å½“æˆ‘ç”¨æ‰‹æœºä¸Šä¼ å›¾ç‰‡æ—¶ï¼Œå‘ç°å‹ç¼©åçš„å›¾ç‰‡éƒ½æ­ªäº†ã€‚ç»è¿‡æŸ¥æ‰¾ï¼Œå‘ç°é—®é¢˜å‡ºåœ¨å›¾ç‰‡çš„exifä¿¡æ¯ä¸­çš„Orientationè®°å½•ï¼Œå®ƒè®°å½•äº†å›¾ç‰‡çš„æ—‹è½¬è§’åº¦ã€‚å› æ­¤ï¼Œéœ€è¦æ ¹æ®è¿™ä¸ªè§’åº¦æ¥æ—‹è½¬å›¾ç‰‡ã€‚</p><p>é¦–å…ˆéœ€è¦è¯»å–å›¾ç‰‡çš„exifä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">from PIL import Imageimg = Image.open('1.jpg')# å…ˆåˆ¤æ–­å›¾ç‰‡æ˜¯å¦æœ‰exifä¿¡æ¯if hasattr(img, '_getexif'):    # è·å–exifä¿¡æ¯    dict_exif = img._getexif()    if dict_exif.get(274, 0) == 3:        # æ—‹è½¬        new_img = img.rotate(-90)    elif dict_exif.get(274, 0) == 6:        # æ—‹è½¬        new_img = img.rotate(180)    else:        new_img = imgelse:    new_img = imgnew_img.save('new_1.jpg')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡è¿™ä¸ªä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å›¾ç‰‡çš„exifä¿¡æ¯ï¼Œå¹¶æ ¹æ®å…¶ä¸­çš„Orientationè®°å½•æ¥æ—‹è½¬å›¾ç‰‡ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†æ­£ç¡®çš„å‹ç¼©åçš„å›¾ç‰‡ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Advanced Usage of Python -- namedtuple</title>
      <link href="//post/python-de-gao-ji-yong-fa-namedtuple.html"/>
      <url>//post/python-de-gao-ji-yong-fa-namedtuple.html</url>
      
        <content type="html"><![CDATA[<p>The <code>namedtuple</code> function can be used to create a named tuple or class, which can be more effective for debugging code. Hereâ€™s an example:</p><pre class="line-numbers language-none"><code class="language-none">from collections import namedtuple# Create a classa = namedtuple('c', ('name', 'age'))x = a('perror', 21)# Access via object methodprint(x.name)print(x.age)# Access via indexingprint(x[0])<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>In addition to inheriting methods from normal tuples, named tuples have three additional methods: the <code>_fields</code> class attribute, <code>make()</code> class method, and <code>_asdict()</code> class instance method.</p><p>Hereâ€™s how to use these methods:</p><pre class="line-numbers language-none"><code class="language-none"># View all fields in the named tupleprint(x._fields)# `_make` generates a class instance using an iterable objects = ('perror', '21')new_s = x._make(s)# Print the tuple's fields in a more friendly format using the class instance methodprint(new_s._asdict())<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Note that after the named tuple is created, its elements can be accessed either by attribute name or by indexing.</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
